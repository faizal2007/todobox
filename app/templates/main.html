<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>{{ config.TITLE }} - {{ title }}</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
        <meta content="Todo application to track down our daily activity" name="description" />
		<link rel="manifest" href="{{ url_for('get_manifest') }}">
		<meta name="theme-color" content="#ff5555">
		<meta name="mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
		<meta name="apple-mobile-web-app-title" content="{{ config.TITLE }}">
		<!-- PWA & platform icons -->
		<link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('static', filename='assets/icons/icon-192x192.png') }}">
		<link rel="icon" type="image/png" sizes="512x512" href="{{ url_for('static', filename='assets/icons/icon-512x512.png') }}">
		<link rel="apple-touch-icon" sizes="192x192" href="{{ url_for('static', filename='assets/icons/icon-192x192.png') }}">
		<link rel="mask-icon" href="{{ url_for('static', filename='assets/images/logo.svg') }}" color="#ff5555">
        <!-- App favicon -->
		
		<link rel="shortcut icon" href='{{ url_for('static', filename='assets/images/favicon.ico') }}'>
        <!-- App css -->
        <link href='{{ url_for('static', filename='assets/css/icons.min.css') }}' rel="stylesheet" type="text/css" />
        <link href='{{ url_for('static', filename='assets/css/app-modern.min.css') }}' rel="stylesheet" type="text/css" id="light-style" />
        <link href='{{ url_for('static', filename='assets/css/app-modern-dark.min.css') }}' rel="stylesheet" type="text/css" id="dark-style" />
        <link href='{{ url_for('static', filename='css/style.css') }}' rel="stylesheet" type="text/css" />
    		<script type="text/javascript">
    			// Initialize PWA and reminder system
    			if (!window.SCRIPT_ROOT) {
    				window.SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
    			}
				// Register service worker for PWA install prompt
				if ('serviceWorker' in navigator) {
					window.addEventListener('load', () => {
						navigator.serviceWorker.register('/service-worker.js').then(reg => {
							console.log('Service Worker registered:', reg);
						}).catch(err => {
							console.error('Service Worker registration failed:', err);
						});
					});
				}
				let deferredPrompt = null;
				const btn = document.getElementById('pwa-install-btn');
				
				// Hide button by default
				if (btn) btn.style.display = 'none';
				
				// Show install button when beforeinstallprompt event fires
				window.addEventListener('beforeinstallprompt', (e) => {
					console.log('beforeinstallprompt event fired');
					e.preventDefault();
					deferredPrompt = e;
					if (btn) {
						btn.style.display = 'inline-flex';
						console.log('Install button shown');
					}
				});
				
				// Hide install button when app is installed
				window.addEventListener('appinstalled', () => {
					console.log('App installed successfully');
					if (btn) btn.style.display = 'none';
					deferredPrompt = null;
				});
				
				// Check if app is already installed on page load
				if (window.navigator.getInstalledRelatedApps) {
					window.navigator.getInstalledRelatedApps().then(apps => {
						console.log('Installed related apps:', apps.length);
						if (apps.length > 0 && btn) {
							btn.style.display = 'none';
						}
					}).catch(err => {
						console.log('getInstalledRelatedApps not fully supported:', err);
					});
				}
				
				function installPWA() {
					console.log('Install button clicked');
					if (!deferredPrompt) {
						console.log('No deferred prompt available');
						return;
					}
					deferredPrompt.prompt();
					deferredPrompt.userChoice.then((result) => { 
						console.log('Install prompt result:', result.outcome);
						if (result.outcome === 'accepted') {
							if (btn) btn.style.display = 'none';
						}
						deferredPrompt = null; 
					});
				}
				
				// Reminder checking system
				function initReminderSystem() {
					// Check for reminders every 10 seconds (more frequent for better UX)
					const reminderCheckInterval = setInterval(checkReminders, 10000);
					// Also check on page load immediately
					checkReminders();
					// Check again after 2 seconds (allow page to fully load)
					setTimeout(checkReminders, 2000);
					console.log('Reminder system initialized - checking every 10 seconds');
					
					// Store interval ID globally so we can clear it if needed
					window.reminderCheckInterval = reminderCheckInterval;
				}
				
				async function checkReminders() {
					try {
						const response = await fetch('/api/reminders/check', {
							method: 'GET',
							headers: {
								'Content-Type': 'application/json'
							}
						});
						
						if (response.ok) {
							const data = await response.json();
							console.log('Reminder check response:', data);
							
							if (data.reminders && data.reminders.length > 0) {
								console.log(`Found ${data.reminders.length} pending reminders`);
								// Process each pending reminder
								data.reminders.forEach(reminder => {
									console.log('Processing reminder:', reminder);
									showReminderNotification(reminder);
								});
							} else {
								console.log('No pending reminders at', new Date().toLocaleTimeString());
							}
						} else {
							console.error('Reminder check failed with status:', response.status);
						}
					} catch (error) {
						console.error('Error checking reminders:', error);
					}
				}
				
			function showReminderNotification(reminder) {
				// Show in-app notification
				const notification = document.createElement('div');
				notification.className = 'alert alert-dismissible fade show reminder-notification';
				
				// Determine styling based on notification count
				let isLastNotification = reminder.is_last_notification || false;
				let notificationCount = reminder.notification_count || 0;
				let alertClass = isLastNotification ? 'alert-danger' : 'alert-warning';
				let borderColor = isLastNotification ? '#ff5555' : '#ff9800';
				let iconColor = isLastNotification ? '#ff5555' : '#ff9800';
				
				notification.className = `alert alert-dismissible fade show reminder-notification ${alertClass}`;
				notification.setAttribute('role', 'alert');
				notification.style.cssText = `
					position: fixed;
					top: 80px;
					right: 20px;
					width: 380px;
					max-width: 90%;
					z-index: 9999;
					box-shadow: ${isLastNotification ? '0 6px 16px rgba(255, 85, 85, 0.3)' : '0 6px 16px rgba(255, 152, 0, 0.3)'};
					animation: slideIn 0.3s ease-out;
					background-color: ${isLastNotification ? '#fff3cd' : '#fff8e1'};
					border: 2px solid ${borderColor};
					border-left: 6px solid ${borderColor};
				`;
				
				// Create time display if available
				let timeDisplay = '';
				if (reminder.reminder_time) {
					const reminderTime = new Date(reminder.reminder_time);
					timeDisplay = `<small style="color: #666; display: block; margin-top: 3px;">Due: ${reminderTime.toLocaleTimeString()}</small>`;
				}
				
				// Create notification count display
				let countDisplay = '';
				let countMessage = '';
				if (notificationCount > 0) {
					if (notificationCount === 1) {
						countMessage = '(1st reminder)';
					} else if (notificationCount === 2) {
						countMessage = '(2nd reminder)';
					} else if (notificationCount >= 3) {
						countMessage = '(Final reminder - will auto-close after this)';
					}
					countDisplay = `<small style="color: ${borderColor}; display: block; margin-top: 5px; font-weight: 600;">${countMessage}</small>`;
				}
				
				notification.innerHTML = `
					<div style="display: flex; align-items: center; gap: 12px;">
						<i class="mdi mdi-bell-ring" style="font-size: 28px; color: ${iconColor}; animation: ${isLastNotification ? 'pulse 0.8s infinite' : 'pulse 1.5s infinite'};"></i>
						<div style="flex: 1;">
							<strong style="color: ${borderColor}; font-size: 16px;">‚è∞ Reminder</strong>
							<div style="font-size: 15px; margin-top: 5px; font-weight: 500;">${reminder.title || 'Task Reminder'}</div>
							${reminder.details ? `<small style="color: #666; display: block; margin-top: 3px;">${reminder.details}</small>` : ''}
							${timeDisplay}
							${countDisplay}
						</div>
					</div>
					<button type="button" class="close" data-dismiss="alert" aria-label="Close" style="position: absolute; right: 10px; top: 10px;">
						<span aria-hidden="true">&times;</span>
					</button>
				`;
				
				// Add animations
				const style = document.createElement('style');
				style.textContent = `
					@keyframes slideIn {
						from {
							transform: translateX(420px);
							opacity: 0;
						}
						to {
							transform: translateX(0);
							opacity: 1;
						}
					}
					@keyframes slideOut {
						from {
							transform: translateX(0);
							opacity: 1;
						}
						to {
							transform: translateX(420px);
							opacity: 0;
						}
					}
					@keyframes pulse {
						0%, 100% {
							opacity: 1;
						}
						50% {
							opacity: 0.5;
						}
					}
				`;
				// Only add style if not already present
				if (!document.querySelector('style[data-reminder-animation]')) {
					style.setAttribute('data-reminder-animation', 'true');
					document.head.appendChild(style);
				}
				
				document.body.appendChild(notification);
				console.log('Reminder notification displayed - Count:', notificationCount, 'Is Last:', isLastNotification);
				
				// Track if user cancelled the reminder
				let reminderCancelled = false;
				let autoDismissTimer;
				
				// Handle close button click - cancel the reminder
				const closeButton = notification.querySelector('.close');
				if (closeButton) {
					closeButton.addEventListener('click', async () => {
						reminderCancelled = true;
						console.log('User cancelled reminder for todo:', reminder.todo_id);
						
						// Clear the auto-dismiss timer
						clearTimeout(autoDismissTimer);
						
						// Remove notification immediately
						notification.style.animation = 'slideOut 0.3s ease-out';
						setTimeout(() => {
							notification.remove();
						}, 300);
						
						// Call cancel API endpoint
						try {
							const response = await fetch(`/api/reminders/${reminder.todo_id}/cancel`, {
								method: 'POST',
								headers: {
									'Content-Type': 'application/json',
									'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value || ''
								}
							});
							if (response.ok) {
								console.log('Reminder cancelled successfully');
							} else {
								console.error('Failed to cancel reminder');
							}
						} catch (error) {
							console.error('Error cancelling reminder:', error);
						}
					});
				}
				
				// Auto-dismiss after 10 seconds (longer than before for visibility)
				// Mark as sent only if user didn't cancel
				autoDismissTimer = setTimeout(async () => {
					notification.style.animation = 'slideOut 0.3s ease-out';
					setTimeout(() => {
						notification.remove();
					}, 300);
					
					// Mark as sent only if not cancelled
					if (!reminderCancelled) {
						console.log('Auto-dismissing reminder, marking as sent');
						await markReminderSent(reminder.todo_id);
					}
				}, 10000);
				
				// Play a subtle notification sound if available (faster pulse for final reminder)
				try {
					const audioContext = new (window.AudioContext || window.webkitAudioContext)();
					const oscillator = audioContext.createOscillator();
					const gainNode = audioContext.createGain();
					oscillator.connect(gainNode);
					gainNode.connect(audioContext.destination);
					
					// Different sound for final reminder
					if (isLastNotification) {
						oscillator.frequency.value = 1000; // Higher pitch for final reminder
						gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
						gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.7);
						oscillator.start(audioContext.currentTime);
						oscillator.stop(audioContext.currentTime + 0.7);
					} else {
						oscillator.frequency.value = 800;
						gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
						gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
						oscillator.start(audioContext.currentTime);
						oscillator.stop(audioContext.currentTime + 0.5);
					}
				} catch (e) {
					// Audio context not supported, silently fail
				}
				
				// Browser notification if supported
				if ('Notification' in window && Notification.permission === 'granted') {
					const notificationTitle = isLastNotification ? 
						`${reminder.title} (Final Reminder)` : 
						reminder.title || 'Task Reminder';
					
					new Notification(notificationTitle, {
						body: reminder.details || 'Time to work on this task',
						icon: '/static/assets/icons/icon-192x192.png',
						tag: `reminder-${reminder.todo_id}`, // Prevent duplicate notifications
						requireInteraction: true, // Keep notification visible until user interacts
						badge: isLastNotification ? '/static/assets/icons/icon-96x96.png' : undefined
					});
				}
			}				async function markReminderSent(todoId) {
					try {
						await fetch('/api/reminders/process', {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json',
								'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value || ''
							},
							body: JSON.stringify({ todo_id: todoId })
						});
					} catch (error) {
						console.error('Error marking reminder as sent:', error);
					}
				}
				
				// Request notification permission on page load
				if ('Notification' in window && Notification.permission === 'default') {
					Notification.requestPermission();
				}
				
				// Initialize reminder system when page is ready
				document.addEventListener('DOMContentLoaded', initReminderSystem);
    		</script>
		{% block extra_css %}{% endblock %}
		{% block extra_script_header %}{% endblock %}
		<script 
			src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js" 
			integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ==" 
			crossorigin="anonymous">
		</script>
        
    </head>
   
    <body class="loading" data-layout="topnav" data-layout-config='{"layoutBoxed":false,"darkMode":false,"showRightSidebarOnStart": true}'>
		<!-- Begin page -->
		<div class="wrapper">

			<!-- ============================================================== -->
			<!-- Start Page Content here -->
			<!-- ============================================================== -->

			<div class="content-page">
					<div class="content">
							<div class="navbar-custom topnav-navbar">
								<div class="container-fluid">
									<a href="{{ url_for('index') }}" class="topnav-logo">
										<img src="https://todobox.geekdo.me/logo.svg" alt="TodoBox Logo" class="logo-icon">
										<p class="h3 text-muted app-title">{{ config.TITLE }}</p>
									</a>
										<a class="navbar-toggle" href="#" role="button" data-toggle="collapse" data-target="#topnav-menu-content" aria-controls="topnav-menu-content" aria-expanded="false" aria-label="Toggle navigation">
											<div class="lines">
												<span></span>
												<span></span>
												<span></span>
											</div>
										</a>
										{% if not current_user.is_anonymous %}
										<ul class="list-unstyled topbar-right-menu float-right mb-0">
											<li class="dropdown notification-list">
												<button id="pwa-install-btn" onclick="installPWA()" title="Install this app on your device">
													<i class="mdi mdi-cloud-download"></i> Install App
												</button>
												<a class="nav-link dropdown-toggle nav-user arrow-none mr-0" data-toggle="dropdown" id="topbar-userdrop" href="#" role="button" aria-haspopup="true"
													aria-expanded="false">
													<span class="account-user-avatar">
														<img src="https://www.gravatar.com/avatar/{{ current_user.email|lower|replace(' ', '')|md5 }}?s=32&d=identicon" alt="user-avatar" class="rounded-circle" referrerpolicy="no-referrer">
													</span>
													<span>
														<span class="account-user-name" title="{{ current_user.email }}">{{ current_user.email }}</span>
														<span class="account-position" id="current-date"></span>
													</span>
												</a>
												<div class="dropdown-menu dropdown-menu-right dropdown-menu-animated topbar-dropdown-menu profile-dropdown" aria-labelledby="topbar-userdrop">
													<!-- item-->
													<div class=" dropdown-header noti-title">
														<h6 class="text-overflow m-0">Welcome !</h6>
													</div>
				
													<!-- item-->
													<a href="{{ url_for('account') }}" class="dropdown-item notify-item">
														<i class="mdi mdi-account-circle mr-1"></i>
														<span>My Account</span>
													</a>
				
													<!-- item-->
													<a href="{{ url_for('settings') }}" class="dropdown-item notify-item">
														<i class="mdi mdi-account-edit mr-1"></i>
														<span>Settings</span>
													</a>

													{% if current_user.is_gmail_user() %}
													<!-- item - sharing (Gmail users only) -->
													<a href="{{ url_for('sharing') }}" class="dropdown-item notify-item">
														<i class="mdi mdi-share-variant mr-1"></i>
														<span>Sharing</span>
													</a>
													{% endif %}
				
													<!-- item-->
													<a href="{{ url_for('logout')}}" class="dropdown-item notify-item">
														<i class="mdi mdi-logout mr-1"></i>
														<span>Logout</span>
													</a>
				
												</div>
											</li>
										</ul>
										{% endif %}
								</div>
							</div>
						<div class="topnav">
							<div class="container-fluid">
								<nav class="navbar navbar-dark navbar-expand-lg topnav-menu">
										<div class="collapse navbar-collapse" id="topnav-menu-content">
											{% if not current_user.is_anonymous %}
											<ul class="navbar-nav">
												<li class="nav-item">
													<a class="nav-link arrow-none" href="{{ url_for('dashboard') }}" id="topnav-dashboard">
														<i class="uil-dashboard mr-1"></i>Dashboard
													</a>
												</li>
											</ul>
											{% endif %}
											{% if not current_user.is_anonymous %}
											<ul class="navbar-nav">
												<li class="nav-item dropdown">
													<a class="nav-link dropdown-toggle arrow-none" href="{{ url_for('list', id='today') }}" id="topnav-today">
														<i class="uil-notes mr-1"></i>Today 
													</a>
												</li>
											</ul>
											<ul class="navbar-nav">
												<li class="nav-item dropdown">
													<a class="nav-link dropdown-toggle arrow-none" href="{{ url_for('list', id='tomorrow') }}" id="topnav-tomorrow">
														<i class="uil-diary-alt mr-1"></i>Tomorrow
													</a>
												</li>
											</ul>
											<ul class="navbar-nav">
												<li class="nav-item dropdown">
													<a class="nav-link dropdown-toggle arrow-none" href="{{ url_for('undone') }}" id="topnav-undone">
														<i class="uil-list-ul mr-1"></i>Undone Tasks
													</a>
												</li>
											</ul>
											{% if current_user.is_gmail_user() %}
											<ul class="navbar-nav">
												<li class="nav-item dropdown">
													<a class="nav-link dropdown-toggle arrow-none" href="{{ url_for('shared_todos') }}" id="topnav-shared">
														<i class="mdi mdi-share-variant mr-1"></i>Shared
													</a>
												</li>
											</ul>
											{% endif %}
											{% if current_user.is_system_admin() %}
											<ul class="navbar-nav">
												<li class="nav-item dropdown">
													<a class="nav-link dropdown-toggle arrow-none" href="{{ url_for('admin_panel') }}" id="topnav-admin">
														<i class="mdi mdi-shield-account mr-1"></i>Admin
													</a>
												</li>
											</ul>
											{% endif %}
											{% endif %}
										</div>
								</nav>
							</div>
						</div>
					</div>

		{% block content %}{% endblock %}
        <!-- bundle -->
		
        <script src='{{ url_for('static', filename='assets/js/vendor.min.js') }}'></script>
        <script src='{{ url_for('static', filename='assets/js/app.min.js') }}'></script>
		
		<script>
			// Set current date using moment.js
			var currentDateEl = document.getElementById('current-date');
			if (currentDateEl) {
				currentDateEl.textContent = moment().format('MMMM DD, YYYY');
			}
		</script>
		
		{% block extra_script_footer %}{% endblock %}
        
    </body>
</html>