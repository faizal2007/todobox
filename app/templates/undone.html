{% extends "main.html" %}
{% block extra_css %}
	<link href='{{ url_for('static', filename='assets/css/vendor/simplemde.min.css') }}' rel="stylesheet" type="text/css" />
{% endblock %}
{% block content %}
     {% set active_page = title %}
               <!-- Start Content-->
               <div class="container-fluid">
                    <!-- start page title -->
                    <div class="row">
                         <div class="col-12 pb-1">
                              <div class="page-title-box">
                                   <h1 class="page-title">
                                        <i class="mdi mdi-format-list-bulleted mr-2"></i>{{ active_page|title }}
                                   </h1>
                                   <p class="text-muted">All your pending and incomplete tasks</p>
                              </div>
                         </div>
                    </div>
                    
                    {% if todos or kiv_todos %}
                    <!-- Nav tabs -->
                    <ul class="nav nav-tabs" id="taskTabs" role="tablist">
                        {% if todos %}
                        <li class="nav-item">
                            <a class="nav-link active" id="uncompleted-tab" data-toggle="tab" href="#uncompleted" role="tab" aria-controls="uncompleted" aria-selected="true">
                                Uncompleted Tasks <span class="badge badge-primary">{{ todos|length }}</span>
                            </a>
                        </li>
                        {% endif %}
                        {% if kiv_todos %}
                        <li class="nav-item">
                            <a class="nav-link{% if not todos %} active{% endif %}" id="kiv-tab" data-toggle="tab" href="#kiv" role="tab" aria-controls="kiv" aria-selected="{% if not todos %}true{% else %}false{% endif %}">
                                KIV Tasks <span class="badge badge-secondary">{{ kiv_todos|length }}</span>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                    
                    <!-- Tab content -->
                    <div class="tab-content mt-3" id="taskTabsContent">
                        {% if todos %}
                        <div class="tab-pane fade show active" id="uncompleted" role="tabpanel" aria-labelledby="uncompleted-tab">
                            <div class="row">
                                {% if todos %}
                                    {% for todo_data in todos %}
                                        {% set list = namespace(Todo=todo_data[0], Tracker=todo_data[1]) %}
                                        <div class="col-md-4">
                                            <div class="card mb-3">
                                                <div class="card-body">
                                                    <div class="card-widgets">
                                                        <a class="done" data-id='{{ list.Todo.id }}' href="#" data-toggle="tooltip" data-original-title="Mark as Done" aria-label="Mark as done">
                                                            <i class="mdi mdi-clipboard-check-outline"></i>
                                                            <span class="sr-only">Mark as done</span>
                                                        </a>
                                                        <a class="kiv ml-2" data-id='{{ list.Todo.id }}' href="#" data-toggle="tooltip" data-original-title="Mark as KIV" aria-label="Mark as KIV">
                                                            <i class="mdi mdi-clock-outline"></i>
                                                            <span class="sr-only">Mark as KIV</span>
                                                        </a>
                                                        <a class="edit pr-2" data-id='{{ list.Todo.id }}' href="#" data-toggle="tooltip" data-original-title="Edit" aria-label="Edit todo">
                                                            <i class="mdi mdi-clipboard-edit-outline"></i>
                                                            <span class="sr-only">Edit todo</span>
                                                        </a>
                                                        <a class="close-todo" data-id='{{ list.Todo.id }}' href="#" data-toggle="tooltip" data-original-title="Delete" aria-label="Delete todo">
                                                            <i class="mdi mdi-close"></i>
                                                            <span class="sr-only">Delete todo</span>
                                                        </a>
                                                    </div>
                                                    <h3 class="card-title mb-0">{{ list.Todo.name|title }}</h3>
                                                    <div class="divider"><hr></div>
                                                    <p class="card-text">{{ list.Todo.details_html|safe }}</p>
                                                    <footer class="blockquote-footer"> 
                                                        <i class="mdi mdi-clock-outline mr-1"></i>
                                                        {{ momentjs(list.Todo.modified).calendar() }}
                                                        {% if list.Tracker.status_id == 1 %}
                                                            <span class="badge badge-warning ml-2">Pending</span>
                                                        {% elif list.Tracker.status_id == 3 %}
                                                            <span class="badge badge-danger ml-2">Failed</span>
                                                        {% elif list.Tracker.status_id == 4 %}
                                                            <span class="badge badge-info ml-2">Re-assigned</span>
                                                        {% endif %}
                                                    </footer>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="col-12">
                                        <div class="alert alert-info">No uncompleted tasks.</div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if kiv_todos %}
                        <div class="tab-pane fade{% if not todos %} show active{% endif %}" id="kiv" role="tabpanel" aria-labelledby="kiv-tab">
                            <div class="row">
                                {% if kiv_todos %}
                                    {% for todo_data in kiv_todos %}
                                        {% set list = namespace(Todo=todo_data[0], Tracker=todo_data[1]) %}
                                        <div class="col-md-4">
                                            <div class="card mb-3">
                                                <div class="card-body">
                                                    <div class="card-widgets">
                                                        <a class="done" data-id='{{ list.Todo.id }}' href="#" data-toggle="tooltip" data-original-title="Mark as Done" aria-label="Mark as done">
                                                            <i class="mdi mdi-clipboard-check-outline"></i>
                                                            <span class="sr-only">Mark as done</span>
                                                        </a>
                                                        <a class="edit pr-2" data-id='{{ list.Todo.id }}' href="#" data-toggle="tooltip" data-original-title="Edit" aria-label="Edit todo">
                                                            <i class="mdi mdi-clipboard-edit-outline"></i>
                                                            <span class="sr-only">Edit todo</span>
                                                        </a>
                                                        <a class="close-todo" data-id='{{ list.Todo.id }}' href="#" data-toggle="tooltip" data-original-title="Delete" aria-label="Delete todo">
                                                            <i class="mdi mdi-close"></i>
                                                            <span class="sr-only">Delete todo</span>
                                                        </a>
                                                    </div>
                                                    <h3 class="card-title mb-0">{{ list.Todo.name|title }}</h3>
                                                    <div class="divider"><hr></div>
                                                    <p class="card-text">{{ list.Todo.details_html|safe }}</p>
                                                    <footer class="blockquote-footer">
                                                        <i class="mdi mdi-clock-outline mr-1"></i>
                                                        {{ momentjs(list.Todo.modified).calendar() }}
                                                        <span class="badge badge-secondary ml-2">KIV</span>
                                                    </footer>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="col-12">
                                        <div class="alert alert-info">No KIV tasks right now.</div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <!-- No undone tasks -->
                    <div class="row">
                         <div class="col-12">
                              <div class="card">
                                   <div class="card-body text-center py-5">
                                        <i class="mdi mdi-check-all text-success" style="font-size: 4rem;"></i>
                                        <h4 class="mt-3">All caught up!</h4>
                                        <p class="text-muted">You have no pending tasks. Great job!</p>
                                        <a href="{{ url_for('list', id='today') }}" class="btn btn-primary">
                                             <i class="mdi mdi-plus mr-1"></i>Add New Task
                                        </a>
                                   </div>
                              </div>
                         </div>
                    </div>
                    {% endif %}
               </div>
          </div>
          {% include "todo_add.html" %}
          {% include "confirm_modal.html" %}
     </div>
{% endblock %}  

{% block extra_script_footer %}
<!-- SimpleMDE js -->
<script src='{{ url_for('static', filename='assets/js/vendor/simplemde.min.js') }}'></script>
<!-- Centralized Todo Operations -->
<script src='{{ url_for('static', filename='assets/js/todo-operations.js') }}'></script>
<script>
     document.addEventListener('DOMContentLoaded', function() {
          // Initialize SimpleMDE editor
          let simplemde = new SimpleMDE({ 
               spellChecker: false,
               toolbarTips: true,
               toolbar: [
                            "bold", 
                            "italic", 
                            "unordered-list", 
                            "ordered-list", "|", 
                            "quote",
                            "link",
                            "preview"
                        ],
               element: document.getElementById("details-textarea")
          });
          
          if (simplemde) {
               simplemde.render();
          }
          
          // Make simplemde globally available
          window.simplemde = simplemde;
     });
</script>

<script>
     document.addEventListener('DOMContentLoaded', function() {
        // Check URL parameter to determine which tab to show
        const urlParams = new URLSearchParams(window.location.search);
        const tabParam = urlParams.get('tab');
        
        // Auto-switch to KIV tab if requested via URL parameter
        if (tabParam === 'kiv') {
            console.log('Detected tab=kiv parameter, auto-switching to KIV tab');
            // Use a small delay to ensure DOM is fully loaded
            setTimeout(function() {
                // Try multiple selectors to find the KIV tab
                let kivTab = document.getElementById('kiv-tab');
                if (!kivTab) {
                    kivTab = document.querySelector('#taskTabs a[href="#kiv"]');
                }
                if (!kivTab) {
                    kivTab = document.querySelector('.nav-link[href="#kiv"]');
                }
                
                console.log('KIV tab element:', kivTab);
                console.log('All tab elements:', document.querySelectorAll('#taskTabs .nav-link'));
                console.log('KIV pane element:', document.getElementById('kiv'));
                
                if (kivTab) {
                    // Try Bootstrap tab API first
                    if (typeof $ !== 'undefined' && $.fn.tab) {
                        console.log('Using Bootstrap tab API');
                        $(kivTab).tab('show');
                    } else {
                        // Fallback to manual tab switching
                        console.log('Using manual tab switching');
                        const kivPane = document.getElementById('kiv');
                        const uncompletedTab = document.getElementById('uncompleted-tab') || document.querySelector('#taskTabs a[href="#uncompleted"]');
                        const uncompletedPane = document.getElementById('uncompleted');
                        
                        // Remove active states from uncompleted tab/pane
                        if (uncompletedTab) {
                            uncompletedTab.classList.remove('active');
                            uncompletedTab.setAttribute('aria-selected', 'false');
                        }
                        if (uncompletedPane) {
                            uncompletedPane.classList.remove('show', 'active');
                        }
                        
                        // Add active states to KIV tab/pane
                        kivTab.classList.add('active');
                        kivTab.setAttribute('aria-selected', 'true');
                        if (kivPane) {
                            kivPane.classList.add('show', 'active');
                        }
                    }
                    
                    console.log('Successfully switched to KIV tab');
                    
                    // Clean up URL parameter AFTER tab switching is complete
                    setTimeout(function() {
                        window.history.replaceState({}, '', window.location.pathname);
                    }, 300);
                } else {
                    console.error('Could not find KIV tab element');
                    console.log('Available elements with "kiv" in ID or class:');
                    document.querySelectorAll('[id*="kiv"], [class*="kiv"]').forEach(el => {
                        console.log(' - Element:', el.tagName, 'ID:', el.id, 'Class:', el.className);
                    });
                }
            }, 150);
        }
        
        // Ensure tab switching works even if Bootstrap JS isn't active
        (function initTabs(){
            const tabs = document.querySelectorAll('#taskTabs a[data-toggle="tab"]');
            const panes = {
                uncompleted: document.getElementById('uncompleted'),
                kiv: document.getElementById('kiv')
            };
            
            tabs.forEach(tab => {
                tab.addEventListener('click', function(e){
                    e.preventDefault();
                    const targetId = this.getAttribute('href').replace('#','');
                    // Update active classes on nav
                    tabs.forEach(t => {
                        t.classList.remove('active');
                        t.setAttribute('aria-selected', 'false');
                    });
                    this.classList.add('active');
                    this.setAttribute('aria-selected', 'true');
                    // Hide all panes
                    Object.values(panes).forEach(p => {
                        if (!p) return;
                        p.classList.remove('show');
                        p.classList.remove('active');
                    });
                    // Show target pane
                    const targetPane = panes[targetId];
                    if (targetPane) {
                        targetPane.classList.add('show');
                        targetPane.classList.add('active');
                    }
                });
            });
        })();

          // Event delegation for todo actions - survives page reloads and dynamic content
          document.addEventListener('click', function(e) {
               var btn = e.target.closest('.done, .kiv, .close-todo');
               if (!btn) return;
               e.preventDefault();
               
               var todoId = btn.dataset.id;
               
               if (btn.classList.contains('done')) {
                    fetch('/' + todoId + '/done', {
                         method: 'POST',
                         headers: {
                              'Content-Type': 'application/x-www-form-urlencoded',
                              'X-CSRFToken': '{{ csrf_token() }}'
                         },
                         body: '_csrf_token=' + encodeURIComponent('{{ csrf_token() }}')
                    })
                    .then(function() {
                         window.location.href = "{{ url_for('undone') }}";
                    })
                    .catch(function(error) {
                         console.error('Error marking todo as done:', error);
                    });
               } else if (btn.classList.contains('kiv')) {
                    console.log('KIV button clicked for todo:', todoId);
                    fetch('/' + todoId + '/kiv', {
                         method: 'POST',
                         headers: {
                              'Content-Type': 'application/x-www-form-urlencoded',
                              'X-CSRFToken': '{{ csrf_token() }}'
                         },
                         body: '_csrf_token=' + encodeURIComponent('{{ csrf_token() }}')
                    })
                    .then(function(response) {
                         console.log('KIV request successful, redirecting to:', "{{ url_for('undone') }}?tab=kiv");
                         window.location.href = "{{ url_for('undone') }}?tab=kiv";
                    })
                    .catch(function(error) {
                         console.error('Error marking todo as kiv:', error);
                    });
               } else if (btn.classList.contains('close-todo')) {
                    var todoTitle = btn.closest('.card-body').querySelector('.card-title').textContent.trim();
                    
                    showConfirmModal(
                         'Delete Todo',
                         'Are you sure you want to delete "' + todoTitle + '"? This action cannot be undone.',
                         function() {
                              fetch('/' + todoId + '/delete', {
                                   method: 'POST',
                                   headers: {
                                        'Content-Type': 'application/x-www-form-urlencoded',
                                        'X-CSRFToken': '{{ csrf_token() }}'
                                   },
                                   body: '_csrf_token=' + encodeURIComponent('{{ csrf_token() }}')
                              })
                              .then(function() {
                                   window.location.href = "{{ url_for('undone') }}";
                              })
                              .catch(function(error) {
                                   console.error('Error deleting todo:', error);
                              });
                         },
                         'Delete',
                         'btn-danger',
                         'bg-danger text-white'
                    );
               }
          });

          // Initialize centralized todo operations (no jQuery needed)
          TodoOperations.initialize({
               simplemde: simplemde,
               csrfToken: '{{ csrf_token() }}',
               redirectUrl: "{{ url_for('undone') }}",
               showLoadingState: false
          });

          // Reset form when modal is closed - use vanilla JS event delegation since jQuery may not be loaded yet
          // This will be enhanced by jQuery modal handlers in main.html after vendor scripts load
          document.addEventListener('hidden.bs.modal', function(event) {
               if (event.target && event.target.id === 'info-header-modal') {
                    // Reset reminder section using vanilla JS
                    var reminderEnabled = document.getElementById('reminder-enabled');
                    if (reminderEnabled) reminderEnabled.checked = false;
                    
                    var reminderOptions = document.getElementById('reminder-options');
                    if (reminderOptions) reminderOptions.style.display = 'none';
                    
                    // Clear Flatpickr properly and destroy to prevent conflicts
                    var reminderInput = document.getElementById('reminder-datetime');
                    if (reminderInput && reminderInput._flatpickr) {
                         reminderInput._flatpickr.destroy();
                    }
                    if (reminderInput) reminderInput.value = '';
                    
                    var reminderMinutes = document.getElementById('reminder-before-minutes');
                    if (reminderMinutes) reminderMinutes.value = '30';
                    
                    var reminderUnit = document.getElementById('reminder-before-unit');
                    if (reminderUnit) reminderUnit.value = 'minutes';
                    
                    // Reset reminder type to "custom"
                    var reminderCustom = document.getElementById('reminder-custom');
                    if (reminderCustom) {
                         reminderCustom.checked = true;
                         // Trigger change event
                         var event = new Event('change', { bubbles: true });
                         reminderCustom.dispatchEvent(event);
                    }
                    
                    var reminderCustomTime = document.getElementById('reminder-custom-time');
                    if (reminderCustomTime) reminderCustomTime.style.display = '';
                    
                    var reminderBeforeOptions = document.getElementById('reminder-before-options');
                    if (reminderBeforeOptions) reminderBeforeOptions.style.display = 'none';
                    
                    // Reset schedule day to "today"
                    var todayOption = document.getElementById('today');
                    if (todayOption) {
                         todayOption.checked = true;
                         var event = new Event('change', { bubbles: true });
                         todayOption.dispatchEvent(event);
                    }
                    
                    var customDatePicker = document.getElementById('custom-date-picker');
                    if (customDatePicker) customDatePicker.style.display = 'none';
                    
                    var customDate = document.getElementById('custom_date');
                    if (customDate) customDate.value = '';
                    
                    // Reset form fields
                    var titleInput = document.getElementById('title-input-normal');
                    if (titleInput) titleInput.value = '';
                    
                    var todoIdInput = document.querySelector("input[name='todo_id']");
                    if (todoIdInput) todoIdInput.value = '';
                    
                    // Reset SimpleMDE editor if it exists
                    if (typeof simplemde !== 'undefined' && simplemde) {
                         simplemde.value('');
                    }
                    
                    // Reset other form states
                    var formControls = document.querySelectorAll('.form-control');
                    formControls.forEach(function(control) {
                         control.classList.remove('is-invalid');
                    });
               }
          });
     });
</script>
{% endblock %}