{% extends "main.html" %}
{% block extra_css %}
	<link href='{{ url_for('static', filename='assets/css/vendor/simplemde.min.css') }}' rel="stylesheet" type="text/css" />
{% endblock %}
{% block content %}
     {% set active_page = title %}
               <!-- Start Content-->
               <div class="container-fluid">
                    <!-- start page title -->
                    <div class="row">
                         <div class="col-12 pb-1">
                              <div class="page-title-box">
                                   <h1 class="page-title">
                                        <i class="mdi mdi-format-list-bulleted mr-2"></i>{{ active_page|title }}
                                   </h1>
                                   <p class="text-muted">All your pending and incomplete tasks</p>
                              </div>
                         </div>
                    </div>
                    
                    {% if todos or kiv_todos %}
                    <!-- Nav tabs -->
                    <ul class="nav nav-tabs" id="taskTabs" role="tablist">
                        {% if todos %}
                        <li class="nav-item">
                            <a class="nav-link active" id="uncompleted-tab" data-toggle="tab" href="#uncompleted" role="tab" aria-controls="uncompleted" aria-selected="true">
                                Uncompleted Tasks <span class="badge badge-primary">{{ todos|length }}</span>
                            </a>
                        </li>
                        {% endif %}
                        {% if kiv_todos %}
                        <li class="nav-item">
                            <a class="nav-link{% if not todos %} active{% endif %}" id="kiv-tab" data-toggle="tab" href="#kiv" role="tab" aria-controls="kiv" aria-selected="{% if not todos %}true{% else %}false{% endif %}">
                                KIV Tasks <span class="badge badge-secondary">{{ kiv_todos|length }}</span>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                    
                    <!-- Tab content -->
                    <div class="tab-content mt-3" id="taskTabsContent">
                        {% if todos %}
                        <div class="tab-pane fade show active" id="uncompleted" role="tabpanel" aria-labelledby="uncompleted-tab">
                            <div class="row">
                                {% if todos %}
                                    {% for todo_data in todos %}
                                        {% set list = namespace(Todo=todo_data[0], Tracker=todo_data[1]) %}
                                        <div class="col-md-4">
                                            <div class="card mb-3">
                                                <div class="card-body">
                                                    <div class="card-widgets">
                                                        <a class="done" data-id='{{ list.Todo.id }}' href="#" data-toggle="tooltip" data-original-title="Mark as Done" aria-label="Mark as done">
                                                            <i class="mdi mdi-clipboard-check-outline"></i>
                                                            <span class="sr-only">Mark as done</span>
                                                        </a>
                                                        <a class="kiv ml-2" data-id='{{ list.Todo.id }}' href="#" data-toggle="tooltip" data-original-title="Mark as KIV" aria-label="Mark as KIV">
                                                            <i class="mdi mdi-clock-outline"></i>
                                                            <span class="sr-only">Mark as KIV</span>
                                                        </a>
                                                        <a class="edit pr-2" data-id='{{ list.Todo.id }}' href="#" data-toggle="tooltip" data-original-title="Edit" aria-label="Edit todo">
                                                            <i class="mdi mdi-clipboard-edit-outline"></i>
                                                            <span class="sr-only">Edit todo</span>
                                                        </a>
                                                        <a class="close-todo" data-id='{{ list.Todo.id }}' href="#" data-toggle="tooltip" data-original-title="Delete" aria-label="Delete todo">
                                                            <i class="mdi mdi-close"></i>
                                                            <span class="sr-only">Delete todo</span>
                                                        </a>
                                                    </div>
                                                    <h3 class="card-title mb-0">{{ list.Todo.name|title }}</h3>
                                                    <div class="divider"><hr></div>
                                                    <p class="card-text">{{ list.Todo.details_html|safe }}</p>
                                                    <footer class="blockquote-footer"> 
                                                        <i class="mdi mdi-clock-outline mr-1"></i>
                                                        {{ momentjs(list.Tracker.timestamp).calendar() }}
                                                        {% if list.Tracker.status_id == 1 %}
                                                            <span class="badge badge-warning ml-2">Pending</span>
                                                        {% elif list.Tracker.status_id == 3 %}
                                                            <span class="badge badge-danger ml-2">Failed</span>
                                                        {% elif list.Tracker.status_id == 4 %}
                                                            <span class="badge badge-info ml-2">Re-assigned</span>
                                                        {% endif %}
                                                    </footer>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="col-12">
                                        <div class="alert alert-info">No uncompleted tasks.</div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if kiv_todos %}
                        <div class="tab-pane fade{% if not todos %} show active{% endif %}" id="kiv" role="tabpanel" aria-labelledby="kiv-tab">
                            <div class="row">
                                {% if kiv_todos %}
                                    {% for todo_data in kiv_todos %}
                                        {% set list = namespace(Todo=todo_data[0], Tracker=todo_data[1]) %}
                                        <div class="col-md-4">
                                            <div class="card mb-3">
                                                <div class="card-body">
                                                    <div class="card-widgets">
                                                        <a class="done" data-id='{{ list.Todo.id }}' href="#" data-toggle="tooltip" data-original-title="Mark as Done" aria-label="Mark as done">
                                                            <i class="mdi mdi-clipboard-check-outline"></i>
                                                            <span class="sr-only">Mark as done</span>
                                                        </a>
                                                        <a class="edit pr-2" data-id='{{ list.Todo.id }}' href="#" data-toggle="tooltip" data-original-title="Edit" aria-label="Edit todo">
                                                            <i class="mdi mdi-clipboard-edit-outline"></i>
                                                            <span class="sr-only">Edit todo</span>
                                                        </a>
                                                        <a class="close-todo" data-id='{{ list.Todo.id }}' href="#" data-toggle="tooltip" data-original-title="Delete" aria-label="Delete todo">
                                                            <i class="mdi mdi-close"></i>
                                                            <span class="sr-only">Delete todo</span>
                                                        </a>
                                                    </div>
                                                    <h3 class="card-title mb-0">{{ list.Todo.name|title }}</h3>
                                                    <div class="divider"><hr></div>
                                                    <p class="card-text">{{ list.Todo.details_html|safe }}</p>
                                                    <footer class="blockquote-footer">
                                                        <i class="mdi mdi-clock-outline mr-1"></i>
                                                        {{ momentjs(list.Tracker.timestamp).calendar() }}
                                                        <span class="badge badge-secondary ml-2">KIV</span>
                                                    </footer>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="col-12">
                                        <div class="alert alert-info">No KIV tasks right now.</div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <!-- No undone tasks -->
                    <div class="row">
                         <div class="col-12">
                              <div class="card">
                                   <div class="card-body text-center py-5">
                                        <i class="mdi mdi-check-all text-success" style="font-size: 4rem;"></i>
                                        <h4 class="mt-3">All caught up!</h4>
                                        <p class="text-muted">You have no pending tasks. Great job!</p>
                                        <a href="{{ url_for('list', id='today') }}" class="btn btn-primary">
                                             <i class="mdi mdi-plus mr-1"></i>Add New Task
                                        </a>
                                   </div>
                              </div>
                         </div>
                    </div>
                    {% endif %}
               </div>
          </div>
          {% include "todo_add.html" %}
          {% include "confirm_modal.html" %}
     </div>
{% endblock %}  

{% block extra_script_footer %}
<!-- SimpleMDE js -->
<script src='{{ url_for('static', filename='assets/js/vendor/simplemde.min.js') }}'></script>
<!-- Centralized Todo Operations -->
<script src='{{ url_for('static', filename='assets/js/todo-operations.js') }}'></script>
<script>
     let simplemde = new SimpleMDE({ 
        spellChecker: false,
        toolbarTips: true,
        toolbar: [
                        "bold", 
                        "italic", 
                        "unordered-list", 
                        "ordered-list", "|", 
                        "quote",
                        "link",
                        "preview"
                    ],
        element: $("#details-textarea")[0] });
        simplemde.render();
</script>

<script>
     document.addEventListener('DOMContentLoaded', function() {
        // Ensure tab switching works even if Bootstrap JS isn't active
        (function initTabs(){
            const tabs = document.querySelectorAll('#taskTabs a[data-toggle="tab"]');
            const panes = {
                uncompleted: document.getElementById('uncompleted'),
                kiv: document.getElementById('kiv')
            };
            tabs.forEach(tab => {
                tab.addEventListener('click', function(e){
                    e.preventDefault();
                    const targetId = this.getAttribute('href').replace('#','');
                    // Update active classes on nav
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    // Hide all panes
                    Object.values(panes).forEach(p => {
                        if (!p) return;
                        p.classList.remove('show');
                        p.classList.remove('active');
                    });
                    // Show target pane
                    const targetPane = panes[targetId];
                    if (targetPane) {
                        targetPane.classList.add('show');
                        targetPane.classList.add('active');
                    }
                });
            });
        })();

          // Event delegation for todo actions - survives page reloads and dynamic content
          document.addEventListener('click', function(e) {
               var btn = e.target.closest('.done, .kiv, .close-todo');
               if (!btn) return;
               e.preventDefault();
               
               var todoId = btn.dataset.id;
               
               if (btn.classList.contains('done')) {
                    fetch('/' + todoId + '/done', {
                         method: 'POST',
                         headers: {
                              'Content-Type': 'application/x-www-form-urlencoded',
                              'X-CSRFToken': '{{ csrf_token() }}'
                         },
                         body: '_csrf_token=' + encodeURIComponent('{{ csrf_token() }}')
                    })
                    .then(function() {
                         window.location.href = "{{ url_for('undone') }}";
                    })
                    .catch(function(error) {
                         console.error('Error marking todo as done:', error);
                    });
               } else if (btn.classList.contains('kiv')) {
                    fetch('/' + todoId + '/kiv', {
                         method: 'POST',
                         headers: {
                              'Content-Type': 'application/x-www-form-urlencoded',
                              'X-CSRFToken': '{{ csrf_token() }}'
                         },
                         body: '_csrf_token=' + encodeURIComponent('{{ csrf_token() }}')
                    })
                    .then(function() {
                         window.location.href = "{{ url_for('undone') }}";
                    })
                    .catch(function(error) {
                         console.error('Error marking todo as kiv:', error);
                    });
               } else if (btn.classList.contains('close-todo')) {
                    var todoTitle = btn.closest('.card-body').querySelector('.card-title').textContent.trim();
                    
                    showConfirmModal(
                         'Delete Todo',
                         'Are you sure you want to delete "' + todoTitle + '"? This action cannot be undone.',
                         function() {
                              fetch('/' + todoId + '/delete', {
                                   method: 'POST',
                                   headers: {
                                        'Content-Type': 'application/x-www-form-urlencoded',
                                        'X-CSRFToken': '{{ csrf_token() }}'
                                   },
                                   body: '_csrf_token=' + encodeURIComponent('{{ csrf_token() }}')
                              })
                              .then(function() {
                                   window.location.href = "{{ url_for('undone') }}";
                              })
                              .catch(function(error) {
                                   console.error('Error deleting todo:', error);
                              });
                         },
                         'Delete',
                         'btn-danger',
                         'bg-danger text-white'
                    );
               }
          });

          // Initialize centralized todo operations
          TodoOperations.initialize({
               simplemde: simplemde,
               csrfToken: '{{ csrf_token() }}',
               redirectUrl: "{{ url_for('undone') }}",
               showLoadingState: false
          });

          // Reset form when modal is closed
          $('#info-header-modal').on('hidden.bs.modal', function() {
               // Reset reminder section
               $('#reminder-enabled').prop('checked', false);
               $('#reminder-options').hide();
               
               // Clear Flatpickr properly and destroy to prevent conflicts
               var reminderInput = document.getElementById('reminder-datetime');
               if (reminderInput && reminderInput._flatpickr) {
                    reminderInput._flatpickr.destroy();
               }
               $('#reminder-datetime').val('');
               
               $('#reminder-before-minutes').val('30');
               $('#reminder-before-unit').val('minutes');
               
               // Reset reminder type to "custom"
               $('#reminder-custom').prop('checked', true).trigger('change');
               $('#reminder-custom-time').show();
               $('#reminder-before-options').hide();
               
               // Reset schedule day to "today"
               $('#today').prop('checked', true).trigger('change');
               $('#custom-date-picker').hide();
               $('#custom_date').val('');
               
               // Reset form fields
               $('#title-input-normal').val('');
               $("input[name='todo_id']").val('');
               
               // Reset SimpleMDE editor if it exists
               if (typeof simplemde !== 'undefined' && simplemde) {
                    simplemde.value('');
               }
               
               // Reset other form states
               $('.form-control').removeClass('is-invalid');
          });
     });
</script>
{% endblock %}