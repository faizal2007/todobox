{% extends "main.html" %}

{% block content %}
<main role="main">
    <div class="jumbotron">
        <div class="container w-50 p-3" style="background-color: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 10px 20px rgba(0, 0, 0, 0.15);">
            <h2>Create Your Account</h2>
            <p class="text-muted">Set up your TodoBox account to get started</p>

            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'danger' if category == 'danger' else 'warning' if category == 'warning' else 'info' }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <!-- Database Error Alert -->
            {% if db_error %}
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <strong>Configuration Error:</strong> {{ db_error }}
                    <br><br>
                    <em>Please contact your system administrator to resolve this database configuration issue.</em>
                    <br><br>
                    <a href="{{ url_for('setup') }}" class="btn btn-secondary btn-sm">← Back to Setup</a>
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            {% endif %}

            <!-- Account Creation Form -->
            <form action="" method="post" id="setupForm">
                {{ form.hidden_tag() }}
                <div class="form-group">
                    {{ form.email.label }}
                    {{ form.email(size=32, class="form-control") }}
                    {% for error in form.email.errors %}
                        <span style="color: red;">[{{ error }}]</span>
                    {% endfor %}
                </div>
                <div class="form-group">
                    {{ form.fullname.label }}
                    {{ form.fullname(size=32, class="form-control") }}
                    {% for error in form.fullname.errors %}
                        <span style="color: red;">[{{ error }}]</span>
                    {% endfor %}
                </div>
                <div class="form-group">
                    {{ form.password.label }}
                    {{ form.password(size=32, class="form-control") }}
                    {% for error in form.password.errors %}
                        <span style="color: red;">[{{ error }}]</span>
                    {% endfor %}
                </div>
                <div class="form-group">
                    {{ form.confirm_password.label }}
                    {{ form.confirm_password(size=32, class="form-control") }}
                    {% for error in form.confirm_password.errors %}
                        <span style="color: red;">[{{ error }}]</span>
                    {% endfor %}
                </div>

                <!-- Submit Button -->
                <div class="row" style="margin-top: 20px;">
                    <div class="col-md-12">
                        <p>{{ form.submit(class="btn btn-primary btn-block") }}</p>
                    </div>
                </div>
            </form>

            <!-- Back to Setup -->
            <div class="text-center my-4">
                <a href="{{ url_for('setup') }}" class="text-muted">← Back to setup options</a>
            </div>
        </div>
    </div>
</main>

<script>
    // Reload page every 10 minutes to refresh CSRF token
    setInterval(function() {
        // Only refresh if user hasn't interacted with the form
        if (document.getElementById('setupForm').dataset.submitted !== 'true') {
            location.reload();
        }
    }, 10 * 60 * 1000);

    // Mark form as submitted when user clicks submit
    document.getElementById('setupForm').addEventListener('submit', function() {
        this.dataset.submitted = 'true';
    });

    // Handle form submission with CSRF error handling
    document.getElementById('setupForm').addEventListener('submit', function(e) {
        if (this.dataset.submitted === 'true') {
            // Prevent double submission
            setTimeout(function() {
                // If page hasn't redirected in 2 seconds, show error
                var alert = document.createElement('div');
                alert.className = 'alert alert-warning alert-dismissible fade show';
                alert.innerHTML = 'Session expired. Please refresh and try again. <button type="button" class="close" data-dismiss="alert">&times;</button>';
                document.querySelector('.jumbotron').insertBefore(alert, document.querySelector('form'));
            }, 2000);
        }
    });
</script>
{% endblock %}