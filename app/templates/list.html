{% extends "main.html" %}
{% block extra_css %}
	<link href='{{ url_for('static', filename='assets/css/vendor/simplemde.min.css') }}' rel="stylesheet" type="text/css" />
{% endblock %}
{% block content %}
<main role="main">
     {% set active_page = title %}
               <!-- Start Content-->
               <div class="container-fluid">
                    <!-- start page title -->
                    <div class="row">
                         <div class="col-12 pb-1">
                              <div class="page-title-box">
                                   <h1 class="page-title">{{ active_page|title }}</h1>
                              </div>
                         </div>
                         
                         <div class="col-sm-4">
                              {% set form_title = 'What to do ? ' %}
                              {% if title == 'today' %}
                              <a id="create-todo-main" type="button" class="btn btn-danger btn-rounded mb-3" data-toggle="modal" data-target="#info-header-modal" href="#">
                                   <i class="mdi mdi-plus"></i>
                                   Create Todo
                              </a>
                              {% endif %}
                         </div>
                         
                         <div class="container-fluid">
                              <div class="row justify-content-center">
                                   <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                   {% for list in todo %}
                                        <div class="col-md-4 col-lg-3 mb-3">
                                             <!-- Portlet card -->
                                             <div class="card h-100">
                                                  <div class="card-body">
                                                       <div class="card-widgets">
                                                            <!-- <button type="button" class="edit" aria-label="Edit" data-id='' data-toggle="modal" data-target="#todoModal">
                                                                 <span aria-hidden="true">&#9998;</span>
                                                             </button> -->
                                                       {% if title == 'today' %}
                                                            <a class="done" data-id='{{ list.Todo.id }}' href="#" data-toggle="tooltip" data-original-title="Done" aria-label="Mark as done">
                                                                <i class="mdi mdi-clipboard-check-outline done-icon"></i>
                                                                <span class="done-loading" style="display: none;">
                                                                    <i class="mdi mdi-loading mdi-spin"></i>
                                                                </span>
                                                                <span class="sr-only">Mark as done</span>
                                                            </a> 
                                                            <a class="kiv ml-2" data-id='{{ list.Todo.id }}' href="#" data-toggle="tooltip" data-original-title="KIV" aria-label="Mark as KIV">
                                                                <i class="mdi mdi-clock-outline kiv-icon"></i>
                                                                <span class="kiv-loading" style="display: none;">
                                                                    <i class="mdi mdi-loading mdi-spin"></i>
                                                                </span>
                                                                <span class="sr-only">Mark as KIV</span>
                                                            </a>
                                                       {% endif %}
                                                            <a class="edit pr-2" data-id='{{ list.Todo.id }}' href="#" data-toggle="tooltip" data-original-title="Edit" aria-label="Edit todo">
                                                                <i class="mdi mdi-clipboard-edit-outline edit-icon"></i>
                                                                <span class="edit-loading" style="display: none;">
                                                                    <i class="mdi mdi-loading mdi-spin"></i>
                                                                </span>
                                                                <span class="sr-only">Edit todo</span>
                                                            </a> 
                                                            <a class="close-todo" data-id='{{ list.Todo.id }}' href="#" data-toggle="tooltip" data-original-title="Delete" aria-label="Delete todo">
                                                                <i class="mdi mdi-close delete-icon"></i>
                                                                <span class="delete-loading" style="display: none;">
                                                                    <i class="mdi mdi-loading mdi-spin"></i>
                                                                </span>
                                                                <span class="sr-only">Delete todo</span>
                                                            </a>
                                                       </div>
                                                       <h3 class="card-title mb-0">{{ list.Todo.name|title }}</h3>
                                                       <div class="divider"><hr></div>
                                                       <p class="card-text">
                                                            {{ list.Todo.details_html|safe }}
                                                       </p>
                                                       <footer class="blockquote-footer"> 
                                                            <i class="uil uil-schedule font-16 mr-1"></i>
                                                            {{ momentjs(list.Tracker.timestamp).calendar() }}
                                                       </footer>
                                                       <div style="margin-top: 15px; text-align: right;">
                                                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 8px 12px; border-radius: 6px; font-size: 11px; font-weight: 500; display: inline-block;">
                                                                 <i class="mdi mdi-lightbulb-on mr-1"></i><span class="card-wisdom" data-id="{{ list.Todo.id }}">...</span>
                                                            </div>
                                                       </div>
                                                  </div>
                                             </div> <!-- end card-->
                                        </div>
                                   {% endfor %}
                              </div>
                         </div>
                         
                    </div>
               </div>
          </div>
          {% include "todo_add.html" %}
          {% include "confirm_modal.html" %}
     </div>
</main>
{% endblock %}  
{% block extra_script_footer %}
<!-- SimpleMDE js -->
<script src='{{ url_for('static', filename='assets/js/vendor/simplemde.min.js') }}'></script>
<!-- Centralized Todo Operations -->
<script src='{{ url_for('static', filename='assets/js/todo-operations.js') }}'></script>
<script>
     document.addEventListener('DOMContentLoaded', function() {
          // Initialize SimpleMDE editor
          let simplemde = new SimpleMDE({ 
               spellChecker: false,
               toolbarTips: true,
               toolbar: [
                            "bold", 
                            "italic", 
                            "unordered-list", 
                            "ordered-list", "|", 
                            "quote",
                            "link",
                            "preview"
                        ],
               element: document.getElementById("details-textarea")
          });
          
          if (simplemde) {
               simplemde.render();
          }
          
          // Make simplemde globally available
          window.simplemde = simplemde;
          const wisdoms = [
               'Stay focused',
               'Small steps, big gains',
               'Consistency beats intensity',
               'Prioritize what matters',
               'Progress over perfection',
               'One task at a time',
               'Momentum starts small',
               'Plan, then execute',
               'Trim distractions',
               'Keep moving forward'
          ];
          const spans = Array.from(document.querySelectorAll('.card-wisdom'));

          // Deterministic mapping across reloads
          // - First todo uses a cached daily wisdom from /api/quote (persisted per day)
          // - Other todos derive wisdom deterministically from their todo IDs
          const todayKey = new Date().toISOString().slice(0,10); // YYYY-MM-DD
          const storageKey = `wisdomOfDay:${todayKey}`;

          function hashStringToIndex(str, modulo) {
               // Simple deterministic hash to index
               let h = 2166136261; // FNV offset basis
               for (let i = 0; i < str.length; i++) {
                    h ^= str.charCodeAt(i);
                    h = (h * 16777619) >>> 0; // FNV prime
               }
               return h % modulo;
          }

          function getTodoIdForSpan(spanEl) {
               // Read todo id directly embedded in span data-id
               const idAttr = spanEl.getAttribute('data-id');
               return idAttr && idAttr.trim() ? idAttr.trim() : null;
          }

          // Resolve wisdom of the day (first card) deterministically via localStorage
          const applyWisdoms = (firstWisdom, firstAuthor=null) => {
               if (spans.length > 0) {
                    spans[0].textContent = firstAuthor ? `${firstWisdom} — ${firstAuthor}` : firstWisdom;
               }
               // Ensure different wisdoms for remaining cards using deterministic DOM order
               const available = wisdoms.filter(w => w !== firstWisdom);
               for (let i = 1; i < spans.length; i++) {
                    const chosen = available[(i - 1) % available.length] || firstWisdom;
                    // Append placeholder author for local wisdoms to keep consistency
                    spans[i].textContent = `${chosen} — Anonymous`;
               }
          };

          const cached = window.localStorage.getItem(storageKey);
          if (cached) {
               applyWisdoms(cached);
          } else {
               fetch('/api/quote', { method: 'GET' })
                    .then(resp => resp.json())
                    .then(data => {
                         const firstWisdom = (data && data.quote) ? data.quote : wisdoms[0];
                         const firstAuthor = (data && data.author) ? data.author : null;
                         try { window.localStorage.setItem(storageKey, firstWisdom); } catch (e) {}
                         applyWisdoms(firstWisdom, firstAuthor);
                    })
                    .catch(() => {
                         // Fallback: deterministic based on date only
                         const idx = hashStringToIndex(todayKey, wisdoms.length);
                         applyWisdoms(wisdoms[idx]);
                    });
          }

          // Mark todo as done
          document.querySelectorAll('.done').forEach(function(button) {
               button.addEventListener('click', function() {
                    var icon = this.querySelector('.done-icon');
                    var loading = this.querySelector('.done-loading');
                    
                    // Show loading state
                    if (icon) icon.style.display = 'none';
                    if (loading) loading.style.display = '';
                    this.disabled = true;
                    
                    fetch(window.SCRIPT_ROOT + this.dataset.id + '/done', {
                         method: 'POST',
                         headers: {
                              'Content-Type': 'application/x-www-form-urlencoded',
                              'X-CSRFToken': '{{ csrf_token() }}'
                         },
                         body: '_csrf_token=' + encodeURIComponent('{{ csrf_token() }}')
                    })
                    .then(function() {
                         window.location.href = "{{ url_for('list', id='today') }}";
                    })
                    .catch(function(error) {
                         console.error('Error marking todo as done:', error);
                         // Hide loading state on error
                         if (icon) icon.style.display = '';
                         if (loading) loading.style.display = 'none';
                         button.disabled = false;
                    });
               });
          });

          // Mark todo as kiv
          document.querySelectorAll('.kiv').forEach(function(button) {
               button.addEventListener('click', function() {
                    var icon = this.querySelector('.kiv-icon');
                    var loading = this.querySelector('.kiv-loading');
                    
                    // Show loading state
                    if (icon) icon.style.display = 'none';
                    if (loading) loading.style.display = '';
                    this.disabled = true;
                    
                    fetch(window.SCRIPT_ROOT + this.dataset.id + '/kiv', {
                         method: 'POST',
                         headers: {
                              'Content-Type': 'application/x-www-form-urlencoded',
                              'X-CSRFToken': '{{ csrf_token() }}'
                         },
                         body: '_csrf_token=' + encodeURIComponent('{{ csrf_token() }}')
                    })
                    .then(function() {
                         window.location.href = "{{ url_for('undone') }}?tab=kiv";
                    })
                    .catch(function(error) {
                         console.error('Error marking todo as kiv:', error);
                         // Hide loading state on error
                         if (icon) icon.style.display = '';
                         if (loading) loading.style.display = 'none';
                         button.disabled = false;
                    });
               });
          });

          // Delete todo
          document.querySelectorAll('.close-todo').forEach(function(button) {
               button.addEventListener('click', function() {
                    var todoId = this.dataset.id;
                    var todoTitle = this.closest('.card-body').querySelector('.card-title').textContent.trim();
                    
                    showConfirmModal(
                         'Delete Todo',
                         'Are you sure you want to delete "' + todoTitle + '"? This action cannot be undone.',
                         function() {
                              var icon = button.querySelector('.delete-icon');
                              var loading = button.querySelector('.delete-loading');
                              
                              // Show loading state
                              if (icon) icon.style.display = 'none';
                              if (loading) loading.style.display = '';
                              button.disabled = true;
                              
                              var title = '{{ title }}';
                              fetch('/' + todoId + '/delete', {
                                   method: 'POST',
                                   headers: {
                                        'Content-Type': 'application/x-www-form-urlencoded',
                                        'X-CSRFToken': '{{ csrf_token() }}'
                                   },
                                   body: '_csrf_token=' + encodeURIComponent('{{ csrf_token() }}')
                              })
                              .then(function() {
                                   if(title == 'today')
                                        window.location.href = "{{ url_for('list', id='today') }}";
                                   else
                                        window.location.href = "{{ url_for('list', id='tomorrow') }}";
                              })
                              .catch(function(error) {
                                   console.error('Error deleting todo:', error);
                                   // Hide loading state on error
                                   if (icon) icon.style.display = '';
                                   if (loading) loading.style.display = 'none';
                                   button.disabled = false;
                              });
                         },
                         'Delete',
                         'btn-danger',
                         'bg-danger text-white'
                    );
               });
          });

          // reset value
          var createTodoBtn = document.getElementById('create-todo-main');
          if (createTodoBtn) {
               createTodoBtn.addEventListener('click', function() {
                    document.getElementById('title-input-normal').value = '';
                    document.querySelector("input[name='todo_id']").value = '';
                    simplemde.value('');
                    
                    // Reset schedule selection to today
                    document.querySelector('input[name="schedule_day"][value="today"]').checked = true;
                    document.querySelector('label[for="today"]').classList.add('active');
                    document.querySelectorAll('label[for="tomorrow"], label[for="custom_day"]').forEach(function(label) {
                         label.classList.remove('active');
                    });
                    document.getElementById('custom-date-picker').style.display = 'none';
                    
                    // Reset reminder fields
                    document.getElementById('reminder-enabled').checked = false;
                    document.getElementById('reminder-options').style.display = 'none';
                    document.querySelector('input[name="reminder_type"][value="custom"]').checked = true;
                    document.getElementById('reminder-datetime').value = '';
                    document.getElementById('reminder-before-minutes').value = '30';
                    document.getElementById('reminder-before-unit').value = 'minutes';
                    document.getElementById('reminder-custom-time').style.display = '';
                    document.getElementById('reminder-before-options').style.display = 'none';
               });
          }

          // Define redirect function based on schedule selection
          var redirectFunction = function(schedule_day) {
               if (schedule_day === 'tomorrow') {
                    return "{{ url_for('list', id='tomorrow') }}";
               } else if (schedule_day === 'custom') {
                    return "{{ url_for('list', id='today') }}";
               } else {
                    return "{{ url_for('list', id='today') }}";
               }
          };
          
          // Initialize all todo operations at once
          TodoOperations.initialize({
               simplemde: simplemde,
               csrfToken: '{{ csrf_token() }}',
               redirectUrl: redirectFunction,
               showLoadingState: true
          });
          
          // Reset form when modal is closed - use vanilla JS event delegation since jQuery may not be loaded yet
          // This will be enhanced by jQuery modal handlers in main.html after vendor scripts load
          document.addEventListener('hidden.bs.modal', function(event) {
               if (event.target && event.target.id === 'info-header-modal') {
                    // Reset reminder section using vanilla JS
                    var reminderEnabled = document.getElementById('reminder-enabled');
                    if (reminderEnabled) reminderEnabled.checked = false;
                    
                    var reminderOptions = document.getElementById('reminder-options');
                    if (reminderOptions) reminderOptions.style.display = 'none';
                    
                    // Clear Flatpickr properly and destroy to prevent conflicts
                    var reminderInput = document.getElementById('reminder-datetime');
                    if (reminderInput && reminderInput._flatpickr) {
                         reminderInput._flatpickr.destroy();
                    }
                    if (reminderInput) reminderInput.value = '';
                    
                    var reminderMinutes = document.getElementById('reminder-before-minutes');
                    if (reminderMinutes) reminderMinutes.value = '30';
                    
                    var reminderUnit = document.getElementById('reminder-before-unit');
                    if (reminderUnit) reminderUnit.value = 'minutes';
                    
                    // Reset reminder type to "custom"
                    var reminderCustom = document.getElementById('reminder-custom');
                    if (reminderCustom) {
                         reminderCustom.checked = true;
                         // Trigger change event
                         var event = new Event('change', { bubbles: true });
                         reminderCustom.dispatchEvent(event);
                    }
                    
                    var reminderCustomTime = document.getElementById('reminder-custom-time');
                    if (reminderCustomTime) reminderCustomTime.style.display = '';
                    
                    var reminderBeforeOptions = document.getElementById('reminder-before-options');
                    if (reminderBeforeOptions) reminderBeforeOptions.style.display = 'none';
                    
                    // Reset schedule day to "today"
                    var todayOption = document.getElementById('today');
                    if (todayOption) {
                         todayOption.checked = true;
                         var event = new Event('change', { bubbles: true });
                         todayOption.dispatchEvent(event);
                    }
                    
                    var customDatePicker = document.getElementById('custom-date-picker');
                    if (customDatePicker) customDatePicker.style.display = 'none';
                    
                    var customDate = document.getElementById('custom_date');
                    if (customDate) customDate.value = '';
                    
                    // Reset form fields
                    var titleInput = document.getElementById('title-input-normal');
                    if (titleInput) titleInput.value = '';
                    
                    var todoIdInput = document.querySelector("input[name='todo_id']");
                    if (todoIdInput) todoIdInput.value = '';
                    
                    // Reset SimpleMDE editor if it exists
                    if (typeof simplemde !== 'undefined' && simplemde) {
                         simplemde.value('');
                    }
                    
                    // Reset other form states
                    var formControls = document.querySelectorAll('.form-control');
                    formControls.forEach(function(control) {
                         control.classList.remove('is-invalid');
                    });
               }
          }); // Close modal event listener
     }); // Close the DOMContentLoaded event listener
</script>
{% endblock %} 



