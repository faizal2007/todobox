{% extends "main.html" %}
{% block extra_css %}
	<link href='{{ url_for('static', filename='assets/css/vendor/simplemde.min.css') }}' rel="stylesheet" type="text/css" />
{% endblock %}
{% block content %}
     {% set active_page = title %}
               <!-- Start Content-->
               <div class="container-fluid">
                    <!-- start page title -->
                    <div class="row">
                         <div class="col-12 pb-1">
                              <div class="page-title-box">
                                   <h1 class="page-title">{{ active_page|title }}</h1>
                              </div>
                         </div>
                         
                         <div class="col-sm-4">
                              {% set form_title = 'What to do ? ' %}
                              {% if title == 'today' %}
                              <a id="create-todo-main" type="button" class="btn btn-danger btn-rounded mb-3" data-toggle="modal" data-target="#info-header-modal" href="#">
                                   <i class="mdi mdi-plus"></i>
                                   Create Todo
                              </a>
                              {% endif %}
                         </div>
                         
                         <div class="container-fluid">
                              <div class="row justify-content-center">
                                   <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                   {% for list in todo %}
                                        <div class="col-md-4 col-lg-3 mb-3">
                                             <!-- Portlet card -->
                                             <div class="card h-100">
                                                  <div class="card-body">
                                                       <div class="card-widgets">
                                                            <!-- <button type="button" class="edit" aria-label="Edit" data-id='' data-toggle="modal" data-target="#todoModal">
                                                                 <span aria-hidden="true">&#9998;</span>
                                                             </button> -->
                                                       {% if title == 'today' %}
                                                            <a class="done" data-id='{{ list.Todo.id }}' href="#" data-toggle="tooltip" data-original-title="Done" aria-label="Mark as done">
                                                                <i class="mdi mdi-clipboard-check-outline done-icon"></i>
                                                                <span class="done-loading" style="display: none;">
                                                                    <i class="mdi mdi-loading mdi-spin"></i>
                                                                </span>
                                                                <span class="sr-only">Mark as done</span>
                                                            </a> 
                                                       {% endif %}
                                                            <a class="edit pr-2" data-id='{{ list.Todo.id }}' href="#" data-toggle="tooltip" data-original-title="Edit" aria-label="Edit todo">
                                                                <i class="mdi mdi-clipboard-edit-outline edit-icon"></i>
                                                                <span class="edit-loading" style="display: none;">
                                                                    <i class="mdi mdi-loading mdi-spin"></i>
                                                                </span>
                                                                <span class="sr-only">Edit todo</span>
                                                            </a> 
                                                            <a class="close-todo" data-id='{{ list.Todo.id }}' href="#" data-toggle="tooltip" data-original-title="Delete" aria-label="Delete todo">
                                                                <i class="mdi mdi-close delete-icon"></i>
                                                                <span class="delete-loading" style="display: none;">
                                                                    <i class="mdi mdi-loading mdi-spin"></i>
                                                                </span>
                                                                <span class="sr-only">Delete todo</span>
                                                            </a>
                                                       </div>
                                                       <h3 class="card-title mb-0">{{ list.Todo.name|title }}</h3>
                                                       <div class="divider"><hr></div>
                                                       <p class="card-text">
                                                            {{ list.Todo.details_html|safe }}
                                                       </p>
                                                       <footer class="blockquote-footer"> 
                                                            <i class="uil uil-schedule font-16 mr-1"></i>
                                                            {{ momentjs(list.Tracker.timestamp).calendar() }}
                                                       </footer>
                                                       <div style="margin-top: 15px; text-align: right;">
                                                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 8px 12px; border-radius: 6px; font-size: 11px; font-weight: 500; display: inline-block;">
                                                                 <i class="mdi mdi-lightbulb-on mr-1"></i><span class="card-wisdom">Stay focused</span>
                                                            </div>
                                                       </div>
                                                  </div>
                                             </div> <!-- end card-->
                                        </div>
                                   {% endfor %}
                              </div>
                         </div>
                         
                    </div>
               </div>
          </div>
          {% include "todo_add.html" %}
          {% include "confirm_modal.html" %}
     </div>
{% endblock %}  
{% block extra_script_footer %}
<!-- SimpleMDE js -->
<script src='{{ url_for('static', filename='assets/js/vendor/simplemde.min.js') }}'></script>
<script>
     let simplemde = new SimpleMDE({ 
        spellChecker: false,
        toolbarTips: true,
        toolbar: [
                        "bold", 
                        "italic", 
                        "unordered-list", 
                        "ordered-list", "|", 
                        "quote",
                        "link",
                        "preview"
                    ],
        element: $("#details-textarea")[0] });
        simplemde.render();
</script>
<!-- SimpleMDE demo -->
<!-- <script src="assets/js/pages/demo.simplemde.js"></script> -->
                                                                                                    
<script>
     $('.done').click(function() {
          var $button = $(this);
          var $icon = $button.find('.done-icon');
          var $loading = $button.find('.done-loading');
          
          // Show loading state
          $icon.hide();
          $loading.show();
          $button.prop('disabled', true);
          
          $.post($SCRIPT_ROOT + $button.data('id') + '/done', {
            '_csrf_token': '{{ csrf_token() }}'
          },
          function(data){
               window.location.href = "{{ url_for('list', id='today') }}";
          }).fail(function() {
               // Hide loading state on error
               $icon.show();
               $loading.hide();
               $button.prop('disabled', false);
          });
     })

     $('.edit').click(function() {
          var $button = $(this);
          var $icon = $button.find('.edit-icon');
          var $loading = $button.find('.edit-loading');
          
          // Show loading state
          $icon.hide();
          $loading.show();
          $button.prop('disabled', true);
          
          $.post('/' + $(this).data('id') + '/todo', {
            '_csrf_token': '{{ csrf_token() }}'
          },
          function(data){
               $('#info-header-modal').modal('show');
               $('#title-input-normal').val(data['title']);
               $("input[name='todo_id']").val(data['id']);
               simplemde.value(data['activities']);
               
               // Load reminder data if it exists
               if (data['reminder_enabled']) {
                    $('#reminder-enabled').prop('checked', true);
                    $('#reminder-options').show();
                    
                    // Determine reminder type from reminder_time
                    if (data['reminder_time']) {
                         // For now, set to custom time type
                         $('input[name="reminder_type"][value="custom"]').prop('checked', true).trigger('change');
                         // Extract just the date-time part (YYYY-MM-DDTHH:mm) from ISO format
                         let reminderDateTime = data['reminder_time'];
                         // Handle both formats: with and without timezone
                         if (reminderDateTime.includes('T')) {
                              reminderDateTime = reminderDateTime.split('T')[0] + 'T' + reminderDateTime.split('T')[1].substring(0, 5);
                         }
                         $('#reminder-datetime').val(reminderDateTime);
                         console.log('Loaded reminder datetime:', reminderDateTime);
                    }
               } else {
                    $('#reminder-enabled').prop('checked', false);
                    $('#reminder-options').hide();
               }
               
               console.log(data)
               
               // Hide loading state after modal is shown
               $icon.show();
               $loading.hide();
               $button.prop('disabled', false);
          }).fail(function() {
               // Hide loading state on error
               $icon.show();
               $loading.hide();
               $button.prop('disabled', false);
          });
     })

     $('.close-todo').click(function() {
          var $button = $(this);
          var todoId = $button.data('id');
          var todoTitle = $button.closest('.card-body').find('.card-title').text().trim();
          
          showConfirmModal(
               'Delete Todo',
               'Are you sure you want to delete "' + todoTitle + '"? This action cannot be undone.',
               function() {
                    var $icon = $button.find('.delete-icon');
                    var $loading = $button.find('.delete-loading');
                    
                    // Show loading state
                    $icon.hide();
                    $loading.show();
                    $button.prop('disabled', true);
                    
                    let title = '{{ title }}'
                    $.post('/' + todoId + '/delete', {
                      '_csrf_token': '{{ csrf_token() }}'
                    },
                    function(data){
                         if(title == 'today')
                              window.location.href = "{{ url_for('list', id='today') }}";
                         else
                              window.location.href = "{{ url_for('list', id='tomorrow') }}";
                    }).fail(function() {
                         // Hide loading state on error
                         $icon.show();
                         $loading.hide();
                         $button.prop('disabled', false);
                    });
               },
               'Delete',
               'btn-danger',
               'bg-danger text-white'
          );
     })
     // reset value
     $('#create-todo-main').click(function() {
          $('#title-input-normal').val('');
          $("input[name='todo_id']").val('')
          simplemde.value('');
          // Reset schedule selection to today
          $('input[name="schedule_day"][value="today"]').prop('checked', true);
          $('label[for="today"]').addClass('active');
          $('label[for="tomorrow"], label[for="custom_day"]').removeClass('active');
          $('#custom-date-picker').hide();
          
          // Reset reminder fields
          $('#reminder-enabled').prop('checked', false);
          $('#reminder-options').hide();
          $('input[name="reminder_type"][value="custom"]').prop('checked', true);
          $('#reminder-datetime').val('');
          $('#reminder-before-minutes').val('30');
          $('#reminder-before-unit').val('minutes');
          $('#reminder-custom-time').show();
          $('#reminder-before-options').hide();
     })

     // Handle schedule day selection
     $('input[name="schedule_day"]').change(function() {
          console.log('Schedule changed to:', $(this).val());
          if ($(this).val() === 'custom') {
               $('#custom-date-picker').show();
          } else {
               $('#custom-date-picker').hide();
          }
     });

     // Handle label clicks for button group
     $('label[for="today"], label[for="tomorrow"], label[for="custom_day"]').click(function() {
          const targetInput = $(this).attr('for');
          const inputValue = $('#' + targetInput).val();
          
          // Remove active class from all labels
          $('label[for="today"], label[for="tomorrow"], label[for="custom_day"]').removeClass('active');
          // Add active class to clicked label
          $(this).addClass('active');
          
          console.log('Button clicked:', inputValue);
          
          if (inputValue === 'custom') {
               $('#custom-date-picker').show();
          } else {
               $('#custom-date-picker').hide();
          }
     });

     // Reminder functionality
     $('#reminder-enabled').change(function() {
          if ($(this).is(':checked')) {
               $('#reminder-options').slideDown(200);
          } else {
               $('#reminder-options').slideUp(200);
          }
     });

     $('input[name="reminder_type"]').change(function() {
          if ($(this).val() === 'custom') {
               $('#reminder-custom-time').show();
               $('#reminder-before-options').hide();
          } else {
               $('#reminder-custom-time').hide();
               $('#reminder-before-options').show();
          }
     });

     /** Script for html modal **/

     $('.create-todo').click(function() {
          
          let title = $('#title-input-normal').val();
          let activities = simplemde.value();
          let todo_id = $("input[name='todo_id']").val();
          let schedule_day = $('input[name="schedule_day"]:checked').val();
          let custom_date = $('#custom_date').val();
          
          // Reminder data
          let reminderEnabled = $('#reminder-enabled').is(':checked');
          let reminderData = {
               enabled: reminderEnabled,
               type: reminderEnabled ? $('input[name="reminder_type"]:checked').val() : null,
               datetime: reminderEnabled ? $('#reminder-datetime').val() : null,
               beforeMinutes: reminderEnabled ? $('#reminder-before-minutes').val() : null,
               beforeUnit: reminderEnabled ? $('#reminder-before-unit').val() : null
          };
          
          if(title) {
               var $button = $(this);
               var $icon = $button.find('.create-icon');
               var $loading = $button.find('.create-loading');
               
               // Show loading state
               $icon.hide();
               $loading.show();
               $button.prop('disabled', true);
               
               $.post('/add', {
                    '_csrf_token': '{{ csrf_token() }}',
                    'todo_id': todo_id ? todo_id:'',
                    'title': title,
                    'activities': activities,
                    'schedule_day': schedule_day,
                    'custom_date': custom_date,
                    'reminder_enabled': reminderData.enabled,
                    'reminder_type': reminderData.type,
                    'reminder_datetime': reminderData.datetime,
                    'reminder_before_minutes': reminderData.beforeMinutes,
                    'reminder_before_unit': reminderData.beforeUnit
               },
               function(data){
                    console.log('Server response:', data);
                    // Redirect based on schedule selection
                    if (schedule_day === 'tomorrow') {
                         window.location.href = "{{ url_for('list', id='tomorrow') }}";
                    } else if (schedule_day === 'custom') {
                         // For custom dates, redirect to today page for now
                         // Could be enhanced to create a custom date view
                         window.location.href = "{{ url_for('list', id='today') }}";
                    } else {
                         window.location.href = "{{ url_for('list', id='today') }}";
                    }
               }).fail(function() {
                    // Hide loading state on error
                    $icon.show();
                    $loading.hide();
                    $button.prop('disabled', false);
               });
          }
          else
               $('#title-input-normal').last().addClass('is-invalid')
          
     })

     $('#info-header-modal').on('shown.bs.modal', function() {
          $(this).find('[autofocus]').focus();
          simplemde.codemirror.refresh();
     });

     $(document).ready(function() {
    
          $(document).keydown(function(event) {
               // Only if modal is visible
               if ($('#info-header-modal').hasClass('show')) {
                    // Detect Ctrl + Enter to save
                    if ((event.ctrlKey || event.metaKey) && event.which === 13) {
                         event.preventDefault();
                         $('.create-todo').click();
                    }
                    
                    // Detect Ctrl + S to save
                    if ((event.ctrlKey || event.metaKey) && event.key === 's') {
                         event.preventDefault();
                         $('.create-todo').click();
                    }
               }
          });
          
          // Add wisdom quotes to each card
          var cardWisdoms = document.querySelectorAll('.card-wisdom');
          var count = cardWisdoms.length;
          
          // Fetch quotes from backend API endpoint
          cardWisdoms.forEach(function(el, index) {
               $.ajax({
                    url: '/api/quote',
                    type: 'GET',
                    timeout: 5000,
                    success: function(data) {
                         if (data.quote) {
                              el.textContent = data.quote;
                         }
                    },
                    error: function() {
                         // Fallback: use a default quote if API fails
                         el.textContent = 'Stay focused';
                    }
               });
          });
     });
</script>
{% endblock %} 



