{% extends "base.html" %}
{% set active_page = 'todo' %}
{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
{% endblock %}
{% block content %}
<main role="main">
    <div class="container">
        <div class="container-fluid mb-3 text-right">
            <!-- Button trigger modal -->
            <button type="button" id="addtodo" class="btn btn-primary" data-toggle="modal" data-target="#todoModal">
                Add Todo
            </button>
        </div>
        <div class="container">
            {## 
                Setup todo dashboard
            ##}
            
            {% set count = namespace(value=0) %}
            {% set column_size = 3 %}
            {% set balance_div = 4 % column_size  %}
            {% set breaker = namespace(value=balance_div) %}
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            
            {% for todo in today_record %}
                {% if loop.index > balance_div %}
                    {% set breaker.value = column_size %}
                {% endif %}
                {% if loop.index == 1 + count.value %}    
                    <div class="card-deck mb-3">
                {% endif %}
                        <div class="card"> 
                            <div class="card-header">
                                <h5>
                                    {{ todo.Todo.name }}
                                </h5>
                            </div>
                            <div class="card-body text-left">
                                {## {{ todo.id }} : ##}
                                <p id="todo-details">
                                        {{ todo.Todo.details_html|safe }}
                                </p>
                                <footer class="blockquote-footer"> {{ momentjs(todo.Tracker.timestamp).calendar() }}</footer>
                            </div>
                            <div class="p-1 mr-2 bg-white">
                                <button type="button" class="ml-2 mb-1 done" aria-label="Done" data-id='{{ todo.id }}'>
                                    <span class="material-icons">
                                        assignment_turned_in
                                    </span>
                                </button>
                                <button type="button" class="ml-2 mb-1 close" aria-label="Close" data-id='{{ todo.Todo.id }}'>
                                    <span aria-hidden="true">&times;</span>
                                </button>
                                <button type="button" class="edit" aria-label="Edit" data-id='{{ todo.Todo.id }}' data-toggle="modal" data-target="#todoModal">
                                    <span aria-hidden="true">&#9998;</span>
                                </button>
                            </div>
                        </div>
                {% if loop.index == breaker.value + count.value %}
                    {% set count.value = count.value + breaker.value %}
                    </div>
                {% endif %}
                
            {% endfor %}
    </div>
    <!-- Modal -->
    <div class="modal fade mt-5" id="todoModal" tabindex="-1" aria-labelledby="todoModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title" id="todoModalLabel">What todo... ?</h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form class="needs-validation">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" name="todo_id"/>
                    <div class="modal-body">
                            <div class="form-group">
                                <label for="titleFormControlInput1">Title</label>
                                <input type="text" class="form-control" id="titleFormControlInput1" name="title" autofocus>
                                <div id="invalidInput1Feedback" class="invalid-feedback">
                                    Please Choose Title.
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="activitiesFormControlTextArea1">Activities</label>
                                <textarea id="activitiesFormControlTextArea1" class="form-control" rows="3" name="activities"></textarea>
                            </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" id="today">Today</button>
                        <button type="button" class="btn btn-secondary" id="tomorrow">Tomorrow</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
        
    </main>
{% endblock %}
{% block extra_script %}
<script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
<script>
    let simplemde = new SimpleMDE({ 
        spellChecker: false,
        toolbarTips: true,
        toolbar: [
                        "bold",
                        "italic",
                        {
                            name: "strikethrough",
                            action: function(editor) {
                                 var cm = editor.codemirror;
                                 var selectedText = cm.getSelection();
                                 cm.replaceSelection(selectedText ? "~~" + selectedText + "~~" : "~~text~~");
                                 cm.focus();
                            },
                            className: "fa fa-strikethrough",
                            title: "Strikethrough (Ctrl-Shift-S)",
                            default: true
                       },
                        "heading-1",
                        "heading-2",
                        "heading-3",
                        "unordered-list", 
                        "ordered-list", "|", 
                        "quote",
                        "link",
                        "preview"
                    ],
        element: document.getElementById("activitiesFormControlTextArea1") });
        simplemde.render();
        
        // Add keyboard shortcut for strikethrough (Ctrl+Shift+S)
        simplemde.codemirror.setOption("extraKeys", {
             "Ctrl-Shift-S": function(cm) {
                  var selectedText = cm.getSelection();
                  cm.replaceSelection(selectedText ? "~~" + selectedText + "~~" : "~~text~~");
                  cm.focus();
             },
             "Cmd-Shift-S": function(cm) {
                  var selectedText = cm.getSelection();
                  cm.replaceSelection(selectedText ? "~~" + selectedText + "~~" : "~~text~~");
                  cm.focus();
             }
        });

    document.addEventListener('DOMContentLoaded', function() {
        // Delete todo
        document.querySelectorAll('.close').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                var todoId = this.dataset.id;
                fetch(window.SCRIPT_ROOT + todoId + '/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: '_csrf_token=' + encodeURIComponent('{{ csrf_token() }}')
                })
                .then(function() {
                    window.location.href = "{{ url_for('todo') }}";
                })
                .catch(function(error) {
                    console.error('Error deleting todo:', error);
                });
            });
        });

        // Add todo (Today)
        var todayBtn = document.getElementById('today');
        if (todayBtn) {
            todayBtn.addEventListener('click', function() {
                var titleInput = document.getElementById('titleFormControlInput1');
                var title = titleInput.value;
                
                fetch(window.SCRIPT_ROOT + '/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: new URLSearchParams({
                        '_csrf_token': '{{ csrf_token() }}',
                        'todo_id': '',
                        'title': title,
                        'activities': simplemde.value(),
                        'activities_html': simplemde.value()
                    })
                })
                .then(response => response.json())
                .then(function(data) {
                    if(data['status'] == 'failed') {
                        document.querySelector('form.needs-validation').classList.add('was-invalidated');
                        titleInput.classList.add('is-invalid');
                    }
                    else {
                        window.location.href = "{{ url_for('todo') }}";
                    }
                })
                .catch(function(error) {
                    console.error('Error adding todo:', error);
                });
            });
        }
        
        // Edit todo
        document.querySelectorAll('.edit').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var todoId = this.dataset.id;
                fetch(window.SCRIPT_ROOT + todoId + '/todo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: '_csrf_token=' + encodeURIComponent('{{ csrf_token() }}')
                })
                .then(response => response.json())
                .then(function(data) {
                    document.querySelector('.modal-footer').innerHTML = data['button'];
                    document.querySelector("input[name='todo_id']").value = data['id'];
                    document.getElementById('titleFormControlInput1').value = data['title'];
                    simplemde.value(data['activities']);
                })
                .catch(function(error) {
                    console.error('Error fetching todo:', error);
                });
            });
        });

        // Add todo (Tomorrow)
        document.addEventListener('click', function(e) {
            if (e.target && e.target.id === 'tomorrow') {
                fetch(window.SCRIPT_ROOT + '/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: new URLSearchParams({
                        '_csrf_token': '{{ csrf_token() }}',
                        'todo_id': document.querySelector("input[name='todo_id']").value,
                        'title': document.getElementById('titleFormControlInput1').value,
                        'activities': simplemde.value(),
                        'activities_html': simplemde.value(),
                        'tomorrow': '1'
                    })
                })
                .then(function() {
                    window.location.href = "{{ url_for('list', id='tomorrow') }}";
                })
                .catch(function(error) {
                    console.error('Error adding todo:', error);
                });
            }
        });

        // Save todo
        document.addEventListener('click', function(e) {
            if (e.target && e.target.id === 'save') {
                fetch(window.SCRIPT_ROOT + '/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: new URLSearchParams({
                        '_csrf_token': '{{ csrf_token() }}',
                        'todo_id': document.querySelector("input[name='todo_id']").value,
                        'title': document.getElementById('titleFormControlInput1').value,
                        'activities': simplemde.value(),
                        'activities_html': simplemde.value()
                    })
                })
                .then(response => {
                    document.getElementById('titleFormControlInput1').disabled = true;
                    document.getElementById('activitiesFormControlTextArea1').disabled = true;
                    document.querySelector('.modal-footer').innerHTML = '<div class="alert alert-warning" role="alert">Saving ...</div>';
                    return response.json();
                })
                .then(function(data) {
                    if(data['status'] == 'failed') {
                        document.querySelector('.modal-footer').innerHTML = '<div class="alert alert-info alert-dismissible fade show" role="alert">No change made</div>';
                        var alert = document.querySelector('.alert');
                        alert.style.display = 'none';
                        setTimeout(function() {
                            alert.style.display = 'block';
                            alert.remove();
                            document.getElementById('titleFormControlInput1').disabled = false;
                            document.getElementById('activitiesFormControlTextArea1').disabled = false;
                            document.querySelector('.modal-footer').innerHTML = data['button'];
                        }, 2000);
                    }
                    else {
                        document.getElementById('titleFormControlInput1').disabled = true;
                        document.getElementById('activitiesFormControlTextArea1').disabled = true;
                        document.querySelector('.modal-footer').innerHTML = '<div class="alert alert-success alert-dismissible fade show" role="alert">Saving success</div>';
                        var alert = document.querySelector('.alert');
                        alert.style.display = 'none';
                        setTimeout(function() {
                            alert.style.display = 'block';
                            alert.remove();
                            window.location.href = "{{ url_for('todo') }}";
                        }, 4000);
                    }
                })
                .catch(function(error) {
                    console.error('Error saving todo:', error);
                });
            }
        });
        
        // Modal shown event
        var todoModal = document.getElementById('todoModal');
        if (todoModal) {
            todoModal.addEventListener('shown.bs.modal', function() {
                var autofocusEl = this.querySelector('[autofocus]');
                if (autofocusEl) autofocusEl.focus();
                if (simplemde && simplemde.codemirror) {
                    simplemde.codemirror.refresh();
                }
            });
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            var todoModal = document.getElementById('todoModal');
            var isModalOpen = todoModal && todoModal.classList.contains('show');
            
            // Ctrl+Enter (or Cmd+Enter on Mac) to save
            if ((event.ctrlKey || event.metaKey) && event.keyCode === 13) {
                if(isModalOpen) {
                    event.preventDefault();
                    event.stopPropagation();
                    
                    var saveBtn = todoModal.querySelector('#save');
                    if (saveBtn) {
                        saveBtn.click();
                    }
                    return false;
                }
            }
            
            // Regular Enter key behavior (without Ctrl/Cmd)
            if (event.which === 13) {
                if(isModalOpen) {
                    var codeMirrorEditor = document.querySelector(".CodeMirror");
                    var isEditorFocused = codeMirrorEditor && codeMirrorEditor.classList.contains("CodeMirror-focused");
                    
                    if (!isEditorFocused) {
                        var todayBtn = document.getElementById('today');
                        if (todayBtn) {
                            }
                    }
                }
            }
            
            event.preventDefault();
        });
    });
    
 </script>
{% endblock %}
