{% extends "main.html" %}
{% set active_page = title %}
{% block content %}
<div class="container-fluid">
    <!-- Start page title -->
    <div class="row">
        <div class="col-12">
            <div class="page-title-box">
                <h1 class="page-title">
                    <i class="mdi mdi-shield-account mr-2"></i>{{ active_page|title }}
                </h1>
                <div class="page-title-right">
                    <a href="{{ url_for('admin_blocked_accounts') }}" class="btn btn-warning">
                        <i class="mdi mdi-shield-lock mr-1"></i>Blocked Accounts
                    </a>
                </div>
            </div>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            {% set alert_type = 'alert-success' if category == 'success' else 'alert-danger' if category == 'error' else 'alert-warning' if category == 'warning' else 'alert-info' %}
            <div class="row">
                <div class="col-12">
                    <div class="alert {{ alert_type }} alert-dismissible fade show" role="alert">
                        <i class="mdi mdi-{{ 'check-circle' if category == 'success' else 'alert-circle' }} mr-2"></i>
                        {{ message }}
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                </div>
            </div>
        {% endfor %}
    {% endif %}
    {% endwith %}

    <!-- User Management Section -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="mdi mdi-account-group mr-2"></i>User Management
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <p class="text-muted mb-0">
                                Manage all users in the system. You can block users to prevent login, delete users, or grant admin privileges.
                            </p>
                        </div>
                        <div>
                            <button type="button" id="bulk-delete-btn" class="btn btn-danger btn-sm" disabled>
                                <i class="mdi mdi-delete-multiple mr-1"></i>Bulk Delete
                            </button>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover table-striped">
                            <thead class="thead-dark">
                                <tr>
                                    <th width="40">
                                        <input type="checkbox" id="select-all-users" title="Select all users">
                                    </th>
                                    <th>ID</th>
                                    <th>Email</th>
                                    <th>Full Name</th>
                                    <th>Status</th>
                                    <th>Role</th>
                                    <th>Auth Type</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users %}
                                <tr class="{{ 'table-danger' if user.is_blocked else '' }} {{ 'table-warning' if user.id == current_user.id else '' }}">
                                    <td>
                                        {% set is_protected_admin = (user.email is none or user.email == '') %}
                                        {% if user.id != current_user.id and not is_protected_admin %}
                                        <input type="checkbox" class="user-checkbox" value="{{ user.id }}" data-email="{{ user.email }}">
                                        {% elif user.id == current_user.id %}
                                        <span class="text-muted" title="Cannot delete yourself"><i class="mdi mdi-account-lock"></i></span>
                                        {% else %}
                                        <span class="text-muted" title="Protected admin"><i class="mdi mdi-shield-account"></i></span>
                                        {% endif %}
                                    </td>
                                    <td>{{ user.id }}</td>
                                    <td>
                                        <strong>{{ user.email }}</strong>
                                        {% if user.id == current_user.id %}
                                        <span class="badge badge-info ml-1">You</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ user.fullname or '-' }}</td>
                                    <td>
                                        {% if user.is_blocked %}
                                        <span class="badge badge-danger">Blocked</span>
                                        {% else %}
                                        <span class="badge badge-success">Active</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if user.is_system_admin() %}
                                        <span class="badge badge-warning">Admin</span>
                                        {% else %}
                                        <span class="badge badge-secondary">User</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if user.oauth_provider == 'google' %}
                                        <span class="badge badge-info"><i class="mdi mdi-google mr-1"></i>Google</span>
                                        {% else %}
                                        <span class="badge badge-secondary"><i class="mdi mdi-account-key mr-1"></i>Password</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% set is_protected_admin = (user.email is none or user.email == '') %}
                                        {% if user.id != current_user.id and not is_protected_admin %}
                                        <div class="btn-group btn-group-sm" role="group">
                                            <!-- Block/Unblock Button -->
                                            <form method="POST" action="{{ url_for('admin_block_user', user_id=user.id) }}" class="d-inline">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                {% if user.is_blocked %}
                                                <button type="submit" class="btn btn-success btn-sm" title="Unblock User">
                                                    <i class="mdi mdi-account-check"></i>
                                                </button>
                                                {% else %}
                                                <button type="submit" class="btn btn-warning btn-sm" title="Block User">
                                                    <i class="mdi mdi-account-off"></i>
                                                </button>
                                                {% endif %}
                                            </form>
                                            
                                            <!-- Toggle Admin Button (only for users with email) -->
                                            {% if user.email %}
                                            <form method="POST" action="{{ url_for('admin_toggle_admin', user_id=user.id) }}" class="d-inline">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                {% if user.is_admin %}
                                                <button type="submit" class="btn btn-secondary btn-sm" title="Remove Admin">
                                                    <i class="mdi mdi-shield-off"></i>
                                                </button>
                                                {% else %}
                                                <button type="submit" class="btn btn-info btn-sm" title="Make Admin">
                                                    <i class="mdi mdi-shield-account"></i>
                                                </button>
                                                {% endif %}
                                            </form>
                                            {% endif %}
                                            
                                            <!-- Delete Button -->
                                            <form method="POST" action="{{ url_for('admin_delete_user', user_id=user.id) }}" class="d-inline delete-user-form">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                <button type="button" class="btn btn-danger btn-sm delete-user-btn" title="Delete User"
                                                        data-email="{{ user.email }}">
                                                    <i class="mdi mdi-delete"></i>
                                                </button>
                                            </form>
                                        </div>
                                        {% elif user.id == current_user.id %}
                                        <span class="text-muted"><em>Current user</em></span>
                                        {% else %}
                                        <span class="text-muted"><em>Protected admin</em></span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    {% if not users %}
                    <div class="alert alert-info">
                        <i class="mdi mdi-information mr-2"></i>
                        No users found in the system.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Legend Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="mdi mdi-help-circle mr-2"></i>Actions Legend
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <p><button class="btn btn-warning btn-sm"><i class="mdi mdi-account-off"></i></button> Block user - Prevents login</p>
                        </div>
                        <div class="col-md-3">
                            <p><button class="btn btn-success btn-sm"><i class="mdi mdi-account-check"></i></button> Unblock user - Allows login</p>
                        </div>
                        <div class="col-md-3">
                            <p><button class="btn btn-info btn-sm"><i class="mdi mdi-shield-account"></i></button> Make admin - Grant admin privileges</p>
                        </div>
                        <div class="col-md-3">
                            <p><button class="btn btn-danger btn-sm"><i class="mdi mdi-delete"></i></button> Delete user - Remove permanently</p>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-12">
                            <p class="mb-0"><strong>Bulk Operations:</strong> Select multiple users using checkboxes and use the "Bulk Delete" button to delete multiple users at once.</p>
                            <p class="mb-0 text-warning"><i class="mdi mdi-alert-circle mr-1"></i><strong>Protection:</strong> You cannot select or delete yourself, and protected administrators (users without email) cannot be deleted.</p>
                        </div>
                    </div>
                    <hr>
                    <p class="mb-0 text-muted">
                        <strong>Note:</strong> Users without an email address are considered system administrators and cannot be blocked, deleted, or demoted.
                        Any user with an email can be granted admin privileges by using the shield button.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

{% include "confirm_modal.html" %}

{% endblock %}

{% block extra_script_footer %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Delete user button handler
    document.querySelectorAll('.delete-user-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var form = this.closest('form');
            var email = this.dataset.email;
            
            showConfirmModal(
                'Delete User',
                'Are you sure you want to delete user "' + email + '"? This action cannot be undone and will delete all their data.',
                function() {
                    form.submit();
                },
                'Delete',
                'btn-danger',
                'bg-danger text-white'
            );
        });
    });

    // Bulk selection functionality
    const selectAllCheckbox = document.getElementById('select-all-users');
    const userCheckboxes = document.querySelectorAll('.user-checkbox');
    const bulkDeleteBtn = document.getElementById('bulk-delete-btn');

    // Handle select all checkbox
    selectAllCheckbox.addEventListener('change', function() {
        const isChecked = this.checked;
        userCheckboxes.forEach(function(checkbox) {
            checkbox.checked = isChecked;
        });
        updateBulkDeleteButton();
    });

    // Handle individual checkboxes
    userCheckboxes.forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            updateBulkDeleteButton();
            // Update select all checkbox state
            const checkedBoxes = document.querySelectorAll('.user-checkbox:checked');
            selectAllCheckbox.checked = checkedBoxes.length === userCheckboxes.length;
            selectAllCheckbox.indeterminate = checkedBoxes.length > 0 && checkedBoxes.length < userCheckboxes.length;
        });
    });

    // Update bulk delete button state
    function updateBulkDeleteButton() {
        const checkedBoxes = document.querySelectorAll('.user-checkbox:checked');
        bulkDeleteBtn.disabled = checkedBoxes.length === 0;
        bulkDeleteBtn.textContent = checkedBoxes.length > 0 ? 
            `Bulk Delete (${checkedBoxes.length})` : 'Bulk Delete';
    }

    // Handle bulk delete button
    bulkDeleteBtn.addEventListener('click', function() {
        const checkedBoxes = document.querySelectorAll('.user-checkbox:checked');
        if (checkedBoxes.length === 0) return;

        const selectedEmails = Array.from(checkedBoxes).map(cb => cb.dataset.email);
        const selectedIds = Array.from(checkedBoxes).map(cb => cb.value);

        showConfirmModal(
            'Bulk Delete Users',
            `Are you sure you want to delete ${checkedBoxes.length} user(s)?\n\nSelected users:\n${selectedEmails.join('\n')}\n\nThis action cannot be undone and will delete all their data.`,
            function() {
                // Create form and submit
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '{{ url_for("admin_bulk_delete_users") }}';
                
                // Add CSRF token
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrf_token';
                csrfInput.value = '{{ csrf_token() }}';
                form.appendChild(csrfInput);
                
                // Add selected user IDs
                selectedIds.forEach(function(id) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'user_ids';
                    input.value = id;
                    form.appendChild(input);
                });
                
                document.body.appendChild(form);
                form.submit();
            },
            'Delete All',
            'btn-danger',
            'bg-danger text-white'
        );
    });
});
</script>
{% endblock %}
