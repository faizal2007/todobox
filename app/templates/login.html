{% extends "main.html" %}

{% block content %}
<main role="main">
    <div class="jumbotron">
        <div class="container w-50 p-3" style="background-color: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 10px 20px rgba(0, 0, 0, 0.15);">
            <h2>Sign In</h2>
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'warning' if category == 'warning' else 'info' }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            
            <!-- Traditional Login Form -->
            <form action="" method="post" id="loginForm">
                {{ form.hidden_tag() }}
                <div class="form-group">
                    {{ form.username.label(for="loginInputEmail") }}
                    {{ form.username(size=32, class="form-control") }}
                    {% for error in form.username.errors %}
                        <span style="color: red;">[{{ error }}]</span>
                    {% endfor %}
                </div>
                <div class="form-group">
                    {{ form.password.label }}
                    {{ form.password(size=32, class="form-control") }}
                    {% for error in form.password.errors %}
                        <span style="color: red;">[{{ error }}]</span>
                    {% endfor %}
                </div>
                <p>{{ form.remember_me() }} {{ form.remember_me.label }}</p>
            </form>
            
            <!-- Divider -->
            <div class="text-center my-4">
                <p class="text-muted"></p>
            </div>
            
            <!-- Login Buttons Row -->
            <div class="row" style="margin-top: 20px;">
                <div class="col-md-6">
                    <form method="post" action="">
                        {{ form.hidden_tag() }}
                        <p>{{ form.submit(class="btn btn-primary btn-block") }}</p>
                    </form>
                </div>
                <div class="col-md-6">
                    <a href="{{ url_for('oauth_login_google') }}" class="btn btn-danger btn-block" role="button">
                        <i class="mdi mdi-google"></i> Sign in with Google
                    </a>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    // Reload page every 10 minutes to refresh CSRF token
    setInterval(function() {
        // Only refresh if user hasn't interacted with the form
        if (document.getElementById('loginForm').dataset.submitted !== 'true') {
            location.reload();
        }
    }, 10 * 60 * 1000);
    
    // Mark form as submitted when user clicks submit
    document.getElementById('loginForm').addEventListener('submit', function() {
        this.dataset.submitted = 'true';
    });
    
    // Handle form submission with CSRF error handling
    document.getElementById('loginForm').addEventListener('submit', function(e) {
        if (this.dataset.submitted === 'true') {
            // Prevent double submission
            setTimeout(function() {
                // If page hasn't redirected in 2 seconds, show error
                var alert = document.createElement('div');
                alert.className = 'alert alert-warning alert-dismissible fade show';
                alert.innerHTML = 'Session expired. Please refresh and try again. <button type="button" class="close" data-dismiss="alert">&times;</button>';
                document.querySelector('.jumbotron').insertBefore(alert, document.querySelector('form'));
            }, 2000);
        }
    });
</script>
{% endblock %}
